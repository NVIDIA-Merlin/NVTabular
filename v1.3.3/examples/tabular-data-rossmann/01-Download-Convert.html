<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Preprocessing the Rossmann Store Sales Dataset &mdash; NVTabular 2021 documentation</title><link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../../_static/mystnb.css" type="text/css" />
      <link rel="stylesheet" href="../../_static/togglebutton.css" type="text/css" />
      <link rel="stylesheet" href="../../_static/css/custom.css" type="text/css" />
    <link rel="canonical" href="https://nvidia-merlin.github.io/NVTabular/main/examples/tabular-data-rossmann/01-Download-Convert.html" />
  <!--[if lt IE 9]>
    <script src="../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  <script id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
        <script src="../../_static/jquery.js"></script>
        <script src="../../_static/underscore.js"></script>
        <script src="../../_static/doctools.js"></script>
        <script >let toggleHintShow = 'Click to show';</script>
        <script >let toggleHintHide = 'Click to hide';</script>
        <script >let toggleOpenOnPrint = 'true';</script>
        <script src="../../_static/togglebutton.js"></script>
        <script >var togglebuttonSelector = '.toggle, .admonition.dropdown, .tag_hide_input div.cell_input, .tag_hide-input div.cell_input, .tag_hide_output div.cell_output, .tag_hide-output div.cell_output, .tag_hide_cell.cell, .tag_hide-cell.cell';</script>
    <script src="../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="next" title="NVTabular demo on Rossmann data - Feature Engineering &amp; Preprocessing" href="02-ETL-with-NVTabular.html" />
    <link rel="prev" title="Applying the Techniques to other Tabular Problems with Rossmann" href="index.html" /> 
</head>

<body class="wy-body-for-nav">
  <div class="banner">
    <p class="banner">
      Beginning in January 2023, versions for all NVIDIA Merlin projects
      will change from semantic versioning like <code>4.0</code>
      to calendar versioning like <code>23.01</code>.</p>
  </div>

  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
            <a href="../../index.html" class="icon icon-home"> NVTabular
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption"><span class="caption-text">Contents</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../../Introduction.html">Introduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../core_features.html">Core Features</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../training/index.html">Accelerated Training</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../index.html">Example Notebooks</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="../index.html#structure">Structure</a></li>
<li class="toctree-l2"><a class="reference internal" href="../index.html#available-example-notebooks">Available Example Notebooks</a></li>
<li class="toctree-l2"><a class="reference internal" href="../index.html#running-the-example-notebooks">Running the Example Notebooks</a></li>
<li class="toctree-l2"><a class="reference internal" href="../index.html#troubleshooting">Troubleshooting</a></li>
<li class="toctree-l2"><a class="reference internal" href="../getting-started-movielens/index.html">Getting Started with MovieLens</a></li>
<li class="toctree-l2"><a class="reference internal" href="../advanced-ops-outbrain/index.html">Advanced Ops with Outbrain</a></li>
<li class="toctree-l2"><a class="reference internal" href="../scaling-criteo/index.html">Scaling to Large Datasets with Criteo</a></li>
<li class="toctree-l2 current"><a class="reference internal" href="index.html">Applying Techniques to Rossmann Stores Data</a><ul class="current">
<li class="toctree-l3 current"><a class="current reference internal" href="#">Preprocessing the Rossmann Store Sales Dataset</a></li>
<li class="toctree-l3"><a class="reference internal" href="02-ETL-with-NVTabular.html">NVTabular demo on Rossmann data - Feature Engineering &amp; Preprocessing</a></li>
<li class="toctree-l3"><a class="reference internal" href="03-Training-with-FastAI.html">NVTabular demo on Rossmann data - FastAI</a></li>
<li class="toctree-l3"><a class="reference internal" href="03-Training-with-TF.html">NVTabular demo on Rossmann data - TensorFlow</a></li>
<li class="toctree-l3"><a class="reference internal" href="03-Training-with-PyTorch.html">NVTabular demo on Rossmann data - PyTorch</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../multi-gpu-movielens/index.html">Multi-GPU Example Notebooks</a></li>
<li class="toctree-l2"><a class="reference internal" href="../winning-solution-recsys2020-twitter/01-02-04-Download-Convert-ETL-with-NVTabular-Training-with-XGBoost.html">Winning Solution of the RecSys2020 Competition</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../api.html">API Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../resources/index.html">Additional Resources</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">NVTabular</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../index.html" class="icon icon-home"></a></li>
          <li class="breadcrumb-item"><a href="../index.html">NVTabular Example Notebooks</a></li>
          <li class="breadcrumb-item"><a href="index.html">Applying the Techniques to other Tabular Problems with Rossmann</a></li>
      <li class="breadcrumb-item active">Preprocessing the Rossmann Store Sales Dataset</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span># Copyright 2021 NVIDIA Corporation. All Rights Reserved.
#
# Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#     http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.
# ==============================================================================
</pre></div>
</div>
</div>
</div>
<img alt="http://developer.download.nvidia.com/compute/machine-learning/frameworks/nvidia_logo.png" src="http://developer.download.nvidia.com/compute/machine-learning/frameworks/nvidia_logo.png" />
<div class="section" id="preprocessing-the-rossmann-store-sales-dataset">
<h1>Preprocessing the Rossmann Store Sales Dataset<a class="headerlink" href="#preprocessing-the-rossmann-store-sales-dataset" title="Permalink to this headline"></a></h1>
<p>Here we implement some feature engineering outlined by FastAI in <a class="reference external" href="https://github.com/fastai/course-v3/blob/master/nbs/dl1/lesson6-rossmann.ipynb">their example solution</a> to the <a class="reference external" href="https://www.kaggle.com/c/rossmann-store-sales">Kaggle Rossmann Store Sales competition</a> using Rapids cuDF library (GPU DataFrame library). We’ve simplified some sections and left out some of the documentation to keep things neat, so feel free to consult the original preprocessing <a class="reference external" href="https://github.com/fastai/course-v3/blob/master/nbs/dl1/rossman_data_clean.ipynb">notebook</a> for explanations of the feature engineering going on.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>import os
import pandas as pd

# Get dataframe library - cudf or pandas
from merlin.core.dispatch import get_lib
df_lib = get_lib()

from merlin.core.utils import download_file
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>INPUT_DATA_DIR = os.environ.get(
    &quot;INPUT_DATA_DIR&quot;, os.path.expanduser(&quot;~/nvt-examples/rossmann/&quot;)
)
OUTPUT_DATA_DIR = os.environ.get(
    &quot;OUTPUT_DATA_DIR&quot;, os.path.expanduser(&quot;~/nvt-examples/data/&quot;)
)
</pre></div>
</div>
</div>
</div>
<p>The cell below will download the data into the <code class="docutils literal notranslate"><span class="pre">INPUT_DATA_DIR</span></code> if you do not have it already.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>if not os.path.isfile(os.path.join(INPUT_DATA_DIR, &quot;rossmann.tgz&quot;)):
    download_file(
        &quot;https://files.fast.ai/part2/lesson14/rossmann.tgz&quot;,
        os.path.join(INPUT_DATA_DIR, &quot;rossmann.tgz&quot;),
    )
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>downloading rossmann.tgz: 7.74MB [00:00, 44.1MB/s]                            
untarring files: 100%|██████████| 8/8 [00:00&lt;00:00, 28.73files/s]
</pre></div>
</div>
</div>
</div>
<p>Let’s read each csv file as a cudf dataframe.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>def read_table(table_name):
    return df_lib.read_csv(os.path.join(INPUT_DATA_DIR, f&quot;{table_name}.csv&quot;))


train = read_table(&quot;train&quot;)
store = read_table(&quot;store&quot;)
store_states = read_table(&quot;store_states&quot;)
state_names = read_table(&quot;state_names&quot;)
googletrend = read_table(&quot;googletrend&quot;)
weather = read_table(&quot;weather&quot;)
test = read_table(&quot;test&quot;)
</pre></div>
</div>
</div>
</div>
<p>StateHoliday column indicates a state holiday. Normally all stores, with few exceptions, are closed on state holidays. Note that all schools are closed on public holidays and weekends. Below, we turn state Holidays to booleans to make them more convenient for modeling.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>train.StateHoliday = train.StateHoliday != &quot;0&quot;
test.StateHoliday = test.StateHoliday != &quot;0&quot;
</pre></div>
</div>
</div>
</div>
<p>Here, new features are added by extracting dates and state names from the given data. Also all instances of state name ‘NI’ are replaced to match the usage in the rest of the data: ‘HB,NI’.</p>
<p>We create a new data frame <code class="docutils literal notranslate"><span class="pre">trend_de</span></code> from the Google trends data that has a special category for the whole of the Germany.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>googletrend[&quot;Date&quot;] = googletrend.week.str.split(&quot; - &quot;, expand=True)[0]
googletrend[&quot;State&quot;] = googletrend.file.str.split(&quot;_&quot;, expand=True)[2]
googletrend[&quot;State&quot;] = googletrend.State.where(googletrend[&quot;State&quot;] != &quot;NI&quot;, &quot;HB,NI&quot;)
trend_de = googletrend.loc[googletrend.file == &quot;Rossmann_DE&quot;].copy()
</pre></div>
</div>
</div>
</div>
<p>The following extracts particular date fields from a complete datetime for the purpose of constructing categoricals. When working with date-time features, you should always consider this feature extraction step. You can capture the trend/cyclical behavior as a function of time at any of these granularities by expanding your date-time into these additional fields. Here, we create <code class="docutils literal notranslate"><span class="pre">Day,</span> <span class="pre">Week,</span> <span class="pre">Month</span> <span class="pre">and</span> <span class="pre">Year</span></code> features, and add these to every table with a date field. Note that cudf currently does not have <code class="docutils literal notranslate"><span class="pre">dt.week</span></code> property, thus, we applied a custom method to create <code class="docutils literal notranslate"><span class="pre">Week</span></code> column.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>for df in (weather, googletrend, train, test, trend_de):
    df[&quot;Date&quot;] = df[&quot;Date&quot;].astype(&quot;datetime64[ns]&quot;)
    df[&quot;Month&quot;] = df.Date.dt.month
    df[&quot;Day&quot;] = df.Date.dt.day
    df[&quot;Year&quot;] = df.Date.dt.year.astype(str) + &quot;-01-01&quot;
    df[&quot;Week&quot;] = (((df[&quot;Date&quot;] - df[&quot;Year&quot;].astype(&quot;datetime64[ns]&quot;)).dt.days) / 7).astype(
        &quot;int16&quot;
    ) + 1
    df[&quot;Week&quot;] = df.Week.where(df[&quot;Week&quot;] != 53, 52)
    df[&quot;Year&quot;] = df.Date.dt.year
</pre></div>
</div>
</div>
</div>
<p>We will use the function below to perform left outer join operation. The suffixes argument describes the naming convention for duplicate fields.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>def merge(df, right, left_on, right_on=None, suffix=None):
    df = df.merge(
        right,
        how=&quot;left&quot;,
        left_on=left_on,
        right_on=right_on or left_on,
        suffixes=(&quot;&quot;, suffix or &quot;_y&quot;),
    )
    return df
</pre></div>
</div>
</div>
</div>
<p>This function will be used to drop redundant or unwanted columns generated via join operations.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>def drop_cols(gdf):
    for c in gdf.columns:
        if c.endswith(&quot;_y&quot;):
            if c in gdf.columns:
                gdf.drop(c, inplace=True, axis=1)
    return gdf
</pre></div>
</div>
</div>
</div>
<p>Now we can outer join all of our data into a single dataframe that we will use to train our DL model.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>weather = merge(weather, state_names, &quot;file&quot;, right_on=&quot;StateName&quot;)
store = merge(store, store_states, &quot;Store&quot;)
train_df = merge(train, store, &quot;Store&quot;)
test_df = merge(test, store, &quot;Store&quot;)
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>train_df = merge(train_df, googletrend, [&quot;State&quot;, &quot;Year&quot;, &quot;Week&quot;])
test_df = merge(test_df, googletrend, [&quot;State&quot;, &quot;Year&quot;, &quot;Week&quot;])
train = test = googletrend = None
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>train_df = merge(train_df, trend_de, [&quot;Year&quot;, &quot;Week&quot;], right_on=[&quot;Year&quot;, &quot;Week&quot;], suffix=&quot;_DE&quot;)
test_df = merge(test_df, trend_de, [&quot;Year&quot;, &quot;Week&quot;], right_on=[&quot;Year&quot;, &quot;Week&quot;], suffix=&quot;_DE&quot;)
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>train_df = drop_cols(train_df)
train_df = merge(train_df, weather, [&quot;State&quot;, &quot;Date&quot;], right_on=[&quot;State&quot;, &quot;Date&quot;], suffix=&quot;_y&quot;)
test_df = drop_cols(test_df)
test_df = merge(test_df, weather, [&quot;State&quot;, &quot;Date&quot;], right_on=[&quot;State&quot;, &quot;Date&quot;])
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span># drop the redundant columns with `_y` suffix.
train_df = drop_cols(train_df)
test_df = drop_cols(test_df)
</pre></div>
</div>
</div>
</div>
<p>Next we’ll fill in missing values to avoid complications with NA’s. Many models have problems when missing values are present, so it’s important to think about how to deal with them. Here, we are picking arbitrary signal values and filling the missing values with them.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>for df in [train_df, test_df]:
    df[&quot;CompetitionOpenSinceYear&quot;] = df.CompetitionOpenSinceYear.fillna(1900).astype(&quot;int32&quot;)
    df[&quot;CompetitionOpenSinceMonth&quot;] = df.CompetitionOpenSinceMonth.fillna(1).astype(&quot;int32&quot;)
    df[&quot;Promo2SinceYear&quot;] = df.Promo2SinceYear.fillna(1900).astype(&quot;int32&quot;)
    df[&quot;Promo2SinceWeek&quot;] = df.Promo2SinceWeek.fillna(1).astype(&quot;int32&quot;)
</pre></div>
</div>
</div>
</div>
<p>Next we’ll extract features “CompetitionOpenSince” and “CompetitionDaysOpen”.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>for df in [train_df, test_df]:
    df[&quot;year&quot;] = df[&quot;CompetitionOpenSinceYear&quot;]
    df[&quot;month&quot;] = df[&quot;CompetitionOpenSinceMonth&quot;]
    df[&quot;day&quot;] = &quot;15&quot;
    df[&quot;CompetitionOpenSince&quot;] = df_lib.to_datetime(df[[&quot;year&quot;, &quot;month&quot;, &quot;day&quot;]])
    df[&quot;CompetitionDaysOpen&quot;] = (df[&quot;Date&quot;] - df[&quot;CompetitionOpenSince&quot;]).dt.days
</pre></div>
</div>
</div>
</div>
<p>Let’s replace some erroneous / outlying data.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>for df in [train_df, test_df]:
    df.loc[df.CompetitionDaysOpen &lt; 0, &quot;CompetitionDaysOpen&quot;] = 0
    df.loc[df.CompetitionOpenSinceYear &lt; 1990, &quot;CompetitionDaysOpen&quot;] = 0
</pre></div>
</div>
</div>
</div>
<p>We’ll now add “CompetitionMonthsOpen” field, limiting the maximum to two years to limit number of unique categories.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>for df in [train_df, test_df]:
    df[&quot;CompetitionMonthsOpen&quot;] = df[&quot;CompetitionDaysOpen&quot;] // 30
    df.loc[df.CompetitionMonthsOpen &gt; 24, &quot;CompetitionMonthsOpen&quot;] = 24
</pre></div>
</div>
</div>
</div>
<p>Same process is applied for Promo dates. We’ll create “Promo2Days”  and “Promo2Weeks” fields, limiting the maximum to 25 weeks to limit number of unique categories.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>for df in [train_df, test_df]:
    df[&quot;Promo2SinceYear_tmp&quot;] = df.Promo2SinceYear.astype(str) + &quot;-01-01&quot;
    dt = df_lib.to_datetime(df.Promo2SinceYear_tmp, format=&quot;%Y&quot;).astype(&quot;int64&quot;) // 10 ** 9
    dt += 7 * 24 * 3600 * df.Promo2SinceWeek
    df[&quot;Promo2Since&quot;] = df_lib.to_datetime(dt * 10 ** 9)
    df[&quot;Promo2Days&quot;] = (df[&quot;Date&quot;] - df[&quot;Promo2Since&quot;]).dt.days
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>for df in [train_df, test_df]:
    df.loc[df.Promo2Days &lt; 0, &quot;Promo2Days&quot;] = 0
    df.loc[df.Promo2SinceYear &lt; 1990, &quot;Promo2Days&quot;] = 0
    df[&quot;Promo2Weeks&quot;] = df[&quot;Promo2Days&quot;] // 7
    df.loc[df.Promo2Weeks &lt; 0, &quot;Promo2Weeks&quot;] = 0
    df.loc[df.Promo2Weeks &gt; 25, &quot;Promo2Weeks&quot;] = 25
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>df = train_df.append(test_df, ignore_index=True)
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span># let&#39;s drop these dummy columns.
df.drop([&quot;year&quot;, &quot;month&quot;, &quot;day&quot;, &quot;Promo2SinceYear_tmp&quot;], inplace=True, axis=1)
train_df.drop([&quot;year&quot;, &quot;month&quot;, &quot;day&quot;, &quot;Promo2SinceYear_tmp&quot;], inplace=True, axis=1)
test_df.drop([&quot;year&quot;, &quot;month&quot;, &quot;day&quot;, &quot;Promo2SinceYear_tmp&quot;], inplace=True, axis=1)
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span># # cast SchoolHoliday to int32.
df[&quot;SchoolHoliday&quot;] = df[&quot;SchoolHoliday&quot;].astype(&quot;int32&quot;)
</pre></div>
</div>
</div>
</div>
<p>This is modififed version of the original <code class="docutils literal notranslate"><span class="pre">get_elapsed</span></code> function from <a class="reference external" href="https://github.com/fastai/course-v3/blob/master/nbs/dl1/rossman_data_clean.ipynb">rossmann_data_clean nb</a>. The <code class="docutils literal notranslate"><span class="pre">get_elapsed</span></code> function is defined for cumulative counting across a sorted dataframe. Given a particular field to monitor, this function starts tracking time since the last occurrence of that field. When the field is seen again, the counter is set to zero.</p>
<p>This section is still not working as intended with cuDF, therefore we are converting the cudf df to pandas df to perform the <code class="docutils literal notranslate"><span class="pre">bfill</span></code> and <code class="docutils literal notranslate"><span class="pre">ffill</span></code> operations below. We can explain the code below by looking at School Holiday as an exp. <i>SchoolHoliday</i> column indicates if the (Store, Date) was affected by the closure of public schools. First every row of the dataframe is sorted in order of store and date. Then, we will add to the dataframe the days since seeing a School Holiday, and the days until another holiday.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span># ops: masking, ffill, bfill, timedelta
df = df.sort_values(by=[&quot;Store&quot;, &quot;Date&quot;])
# We convert cudf dataframe to the pandas df be able to do `bfill` and `ffill` operations below.
if df_lib == pd:
    pdf = df
else:
    pdf = df.to_pandas()
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span># first build a mask indicating where stores start and end
first_indices = pdf.Store.diff() != 0
last_indices = pdf.Store.diff().iloc[1:].append(pd.Series([1]))
last_indices.index = first_indices.index
idx_mask = ~(first_indices | last_indices)

event_fields = [&quot;SchoolHoliday&quot;, &quot;StateHoliday&quot;, &quot;Promo&quot;]
for field in event_fields:
    # use the mask from above to mask save dates from the start and end
    # of a given store&#39;s range, as well as all dates that have an event
    pdf[&quot;tmp&quot;] = pdf.Date
    pdf.loc[(pdf[field] == 0) &amp; idx_mask, &quot;tmp&quot;] = float(&quot;nan&quot;)
    # then use ffill and bbfill to give the input to the time delta
    pdf[&quot;After&quot; + field] = pdf.tmp.ffill()
    pdf[&quot;Before&quot; + field] = pdf.tmp.bfill()

    # compute deltas between bfilled and ffilled dates and the current date
    pdf[&quot;After&quot; + field] = (pdf[&quot;Date&quot;] - pdf[&quot;After&quot; + field]).astype(&quot;timedelta64[D]&quot;)
    pdf[&quot;Before&quot; + field] = (pdf[&quot;Before&quot; + field] - pdf[&quot;Date&quot;]).astype(&quot;timedelta64[D]&quot;)

# get rid of our dummy column
pdf = pdf.drop(columns=[&quot;tmp&quot;])

# let&#39;s convert pandas back to cudf df
if df_lib == pd:
    df = pdf
else:
    df = df_lib.from_pandas(pdf)
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>pd.DataFrame(pdf.dtypes).to_csv(&quot;dtypes_none.csv&quot;)
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span># Set the active index to Date.
df = df.set_index(&quot;Date&quot;)
</pre></div>
</div>
</div>
</div>
<p>Next we’ll apply window calculations in cudf to calculate rolling quantities. Here, we’re sorting by date (sort_index()), grouping by Store column, and counting the number of events of interest (sum()) defined in columns in the following week (rolling()). We do the same in the opposite direction.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>event_fields = [&quot;SchoolHoliday&quot;, &quot;StateHoliday&quot;, &quot;Promo&quot;]
bwd = df[[&quot;Store&quot;] + event_fields].sort_index().groupby(&quot;Store&quot;).rolling(7, min_periods=1).sum()
fwd = (
    df[[&quot;Store&quot;] + event_fields]
    .sort_index(ascending=False)
    .groupby(&quot;Store&quot;)
    .rolling(7, min_periods=1)
    .sum()
)
</pre></div>
</div>
</div>
</div>
<p>Next we drop the Store indices grouped together in the window function.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>for d in (bwd, fwd):
    d.drop(&quot;Store&quot;, 2, inplace=True)
    d.reset_index(inplace=True)
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>df.reset_index(inplace=True)
</pre></div>
</div>
</div>
</div>
<p>Let’s merge these values onto the df, and drop the unwanted columns.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>df = df.merge(
    bwd, left_on=[&quot;Date&quot;, &quot;Store&quot;], right_on=[&quot;Date&quot;, &quot;Store&quot;], how=&quot;left&quot;, suffixes=[&quot;&quot;, &quot;_bw&quot;]
)
df = df.merge(
    fwd, left_on=[&quot;Date&quot;, &quot;Store&quot;], right_on=[&quot;Date&quot;, &quot;Store&quot;], how=&quot;left&quot;, suffixes=[&quot;&quot;, &quot;_fw&quot;]
)
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>train_df = merge(train_df, df, [&quot;Store&quot;, &quot;Date&quot;], right_on=[&quot;Store&quot;, &quot;Date&quot;])
test_df = merge(test_df, df, [&quot;Store&quot;, &quot;Date&quot;], right_on=[&quot;Store&quot;, &quot;Date&quot;])
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>train_df = drop_cols(train_df)
test_df = drop_cols(test_df)
</pre></div>
</div>
</div>
</div>
<p>Next, we are removing all instances where the store had zero sale / was closed, and we sort our training set by Date.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>train_df = train_df[train_df.Sales != 0]
train_df = train_df.sort_values(by=&quot;Date&quot;, ascending=True)
train_df = train_df.reset_index(drop=True)
test_df = test_df.reset_index(drop=True)
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span># determine a cut-off point to create a validation dataset.
cut = train_df[&quot;Date&quot;][(train_df[&quot;Date&quot;] == train_df[&quot;Date&quot;][len(test_df)])].index.max()
cut
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>57696
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span># split the train_df as training and validation data sets.
num_valid = cut
valid_df = train_df[-num_valid:]
train_df = train_df[:-num_valid]
</pre></div>
</div>
</div>
</div>
<p>Let’s save our preprocessed files as csv files to be used in <a class="reference external" href="https://github.com/NVIDIA/NVTabular/blob/main/examples/rossmann/">Rossmann examples</a> for further preprocessing with NVTabular, then for model training and testing with PyT, TF and FastAI frameworks.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>!mkdir -p $OUTPUT_DATA_DIR

train_df.to_csv(os.path.join(OUTPUT_DATA_DIR, &quot;train.csv&quot;), index=False)
valid_df.to_csv(os.path.join(OUTPUT_DATA_DIR, &quot;valid.csv&quot;), index=False)
test_df.to_csv(os.path.join(OUTPUT_DATA_DIR, &quot;test.csv&quot;), index=False)
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>!ls $OUTPUT_DATA_DIR
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>test.csv  train.csv  valid.csv
</pre></div>
</div>
</div>
</div>
</div>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="index.html" class="btn btn-neutral float-left" title="Applying the Techniques to other Tabular Problems with Rossmann" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="02-ETL-with-NVTabular.html" class="btn btn-neutral float-right" title="NVTabular demo on Rossmann data - Feature Engineering &amp; Preprocessing" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2021, NVIDIA.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  
<div class="rst-versions" data-toggle="rst-versions" role="note" aria-label="versions">
  <span class="rst-current-version" data-toggle="rst-current-version">
    <span class="fa fa-book"> Other Versions</span>
    v: v1.3.3
    <span class="fa fa-caret-down"></span>
  </span>
  <div class="rst-other-versions">
    <dl>
      <dt>Tags</dt>
      <dd><a href="../../../v1.3.2/index.html">v1.3.2</a></dd>
      <dd><a href="01-Download-Convert.html">v1.3.3</a></dd>
      <dd><a href="../../../v1.4.0/index.html">v1.4.0</a></dd>
      <dd><a href="../../../v1.5.0/index.html">v1.5.0</a></dd>
      <dd><a href="../../../v1.6.0/index.html">v1.6.0</a></dd>
      <dd><a href="../../../v1.7.0/index.html">v1.7.0</a></dd>
    </dl>
    <dl>
      <dt>Branches</dt>
      <dd><a href="../../../main/index.html">main</a></dd>
    </dl>
  </div>
</div><script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>
    <!-- Theme Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-NVJ1Y1YJHK"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());

      gtag('config', 'G-NVJ1Y1YJHK', {
          'anonymize_ip': false,
      });
    </script> 

</body>
</html>