<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>NVTabular demo on RecSys2020 Challenge &mdash; NVTabular 2020 documentation</title><link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  <script id="documentation_options" data-url_root="../" src="../_static/documentation_options.js"></script>
        <script src="../_static/jquery.js"></script>
        <script src="../_static/underscore.js"></script>
        <script src="../_static/doctools.js"></script>
        <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
        <script async="async" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.7/latest.js?config=TeX-AMS-MML_HTMLorMML"></script>
        <script type="text/x-mathjax-config">MathJax.Hub.Config({"tex2jax": {"inlineMath": [["$", "$"], ["\\(", "\\)"]], "processEscapes": true, "ignoreClass": "tex2jax_ignore|mathjax_ignore|document", "processClass": "tex2jax_process|mathjax_process|math|output_area"}})</script>
    <script src="../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="API Documentation" href="../api/index.html" />
    <link rel="prev" title="NVTabular demo on Outbrain Data" href="outbrain.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
            <a href="../index.html" class="icon icon-home"> NVTabular
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../Introduction.html">Introduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="../HowItWorks.html">How it Works</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="index.html">Examples</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="criteo.html">Criteo Example</a></li>
<li class="toctree-l2"><a class="reference internal" href="rossmann.html">Rossmann Example</a></li>
<li class="toctree-l2"><a class="reference internal" href="multigpu.html">Multi-GPU Example</a></li>
<li class="toctree-l2"><a class="reference internal" href="hugectr.html">HugeCTR Example</a></li>
<li class="toctree-l2"><a class="reference internal" href="outbrain.html">Outbrain Example</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">RecSys2020 Example</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#Overview">Overview</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#RecSys2020-Challenge">RecSys2020 Challenge</a></li>
<li class="toctree-l4"><a class="reference internal" href="#Downloading-the-dataset">Downloading the dataset</a></li>
<li class="toctree-l4"><a class="reference internal" href="#Learning-objectives">Learning objectives</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#Getting-Started">Getting Started</a></li>
<li class="toctree-l3"><a class="reference internal" href="#Preparing-our-dataset">Preparing our dataset</a></li>
<li class="toctree-l3"><a class="reference internal" href="#Splitting-dataset-into-training-and-test">Splitting dataset into training and test</a></li>
<li class="toctree-l3"><a class="reference internal" href="#Feature-Engineering">Feature Engineering</a></li>
<li class="toctree-l3"><a class="reference internal" href="#Training-our-model">Training our model</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../api/index.html">API Documentation</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">NVTabular</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../index.html" class="icon icon-home"></a> &raquo;</li>
          <li><a href="index.html">Examples</a> &raquo;</li>
      <li>NVTabular demo on RecSys2020 Challenge</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  
<style>
/* CSS for nbsphinx extension */

/* remove conflicting styling from Sphinx themes */
div.nbinput.container div.prompt *,
div.nboutput.container div.prompt *,
div.nbinput.container div.input_area pre,
div.nboutput.container div.output_area pre,
div.nbinput.container div.input_area .highlight,
div.nboutput.container div.output_area .highlight {
    border: none;
    padding: 0;
    margin: 0;
    box-shadow: none;
}

div.nbinput.container > div[class*=highlight],
div.nboutput.container > div[class*=highlight] {
    margin: 0;
}

div.nbinput.container div.prompt *,
div.nboutput.container div.prompt * {
    background: none;
}

div.nboutput.container div.output_area .highlight,
div.nboutput.container div.output_area pre {
    background: unset;
}

div.nboutput.container div.output_area div.highlight {
    color: unset;  /* override Pygments text color */
}

/* avoid gaps between output lines */
div.nboutput.container div[class*=highlight] pre {
    line-height: normal;
}

/* input/output containers */
div.nbinput.container,
div.nboutput.container {
    display: -webkit-flex;
    display: flex;
    align-items: flex-start;
    margin: 0;
    width: 100%;
}
@media (max-width: 540px) {
    div.nbinput.container,
    div.nboutput.container {
        flex-direction: column;
    }
}

/* input container */
div.nbinput.container {
    padding-top: 5px;
}

/* last container */
div.nblast.container {
    padding-bottom: 5px;
}

/* input prompt */
div.nbinput.container div.prompt pre {
    color: #307FC1;
}

/* output prompt */
div.nboutput.container div.prompt pre {
    color: #BF5B3D;
}

/* all prompts */
div.nbinput.container div.prompt,
div.nboutput.container div.prompt {
    width: 4.5ex;
    padding-top: 5px;
    position: relative;
    user-select: none;
}

div.nbinput.container div.prompt > div,
div.nboutput.container div.prompt > div {
    position: absolute;
    right: 0;
    margin-right: 0.3ex;
}

@media (max-width: 540px) {
    div.nbinput.container div.prompt,
    div.nboutput.container div.prompt {
        width: unset;
        text-align: left;
        padding: 0.4em;
    }
    div.nboutput.container div.prompt.empty {
        padding: 0;
    }

    div.nbinput.container div.prompt > div,
    div.nboutput.container div.prompt > div {
        position: unset;
    }
}

/* disable scrollbars on prompts */
div.nbinput.container div.prompt pre,
div.nboutput.container div.prompt pre {
    overflow: hidden;
}

/* input/output area */
div.nbinput.container div.input_area,
div.nboutput.container div.output_area {
    -webkit-flex: 1;
    flex: 1;
    overflow: auto;
}
@media (max-width: 540px) {
    div.nbinput.container div.input_area,
    div.nboutput.container div.output_area {
        width: 100%;
    }
}

/* input area */
div.nbinput.container div.input_area {
    border: 1px solid #e0e0e0;
    border-radius: 2px;
    /*background: #f5f5f5;*/
}

/* override MathJax center alignment in output cells */
div.nboutput.container div[class*=MathJax] {
    text-align: left !important;
}

/* override sphinx.ext.imgmath center alignment in output cells */
div.nboutput.container div.math p {
    text-align: left;
}

/* standard error */
div.nboutput.container div.output_area.stderr {
    background: #fdd;
}

/* ANSI colors */
.ansi-black-fg { color: #3E424D; }
.ansi-black-bg { background-color: #3E424D; }
.ansi-black-intense-fg { color: #282C36; }
.ansi-black-intense-bg { background-color: #282C36; }
.ansi-red-fg { color: #E75C58; }
.ansi-red-bg { background-color: #E75C58; }
.ansi-red-intense-fg { color: #B22B31; }
.ansi-red-intense-bg { background-color: #B22B31; }
.ansi-green-fg { color: #00A250; }
.ansi-green-bg { background-color: #00A250; }
.ansi-green-intense-fg { color: #007427; }
.ansi-green-intense-bg { background-color: #007427; }
.ansi-yellow-fg { color: #DDB62B; }
.ansi-yellow-bg { background-color: #DDB62B; }
.ansi-yellow-intense-fg { color: #B27D12; }
.ansi-yellow-intense-bg { background-color: #B27D12; }
.ansi-blue-fg { color: #208FFB; }
.ansi-blue-bg { background-color: #208FFB; }
.ansi-blue-intense-fg { color: #0065CA; }
.ansi-blue-intense-bg { background-color: #0065CA; }
.ansi-magenta-fg { color: #D160C4; }
.ansi-magenta-bg { background-color: #D160C4; }
.ansi-magenta-intense-fg { color: #A03196; }
.ansi-magenta-intense-bg { background-color: #A03196; }
.ansi-cyan-fg { color: #60C6C8; }
.ansi-cyan-bg { background-color: #60C6C8; }
.ansi-cyan-intense-fg { color: #258F8F; }
.ansi-cyan-intense-bg { background-color: #258F8F; }
.ansi-white-fg { color: #C5C1B4; }
.ansi-white-bg { background-color: #C5C1B4; }
.ansi-white-intense-fg { color: #A1A6B2; }
.ansi-white-intense-bg { background-color: #A1A6B2; }

.ansi-default-inverse-fg { color: #FFFFFF; }
.ansi-default-inverse-bg { background-color: #000000; }

.ansi-bold { font-weight: bold; }
.ansi-underline { text-decoration: underline; }


div.nbinput.container div.input_area div[class*=highlight] > pre,
div.nboutput.container div.output_area div[class*=highlight] > pre,
div.nboutput.container div.output_area div[class*=highlight].math,
div.nboutput.container div.output_area.rendered_html,
div.nboutput.container div.output_area > div.output_javascript,
div.nboutput.container div.output_area:not(.rendered_html) > img{
    padding: 5px;
    margin: 0;
}

/* fix copybtn overflow problem in chromium (needed for 'sphinx_copybutton') */
div.nbinput.container div.input_area > div[class^='highlight'],
div.nboutput.container div.output_area > div[class^='highlight']{
    overflow-y: hidden;
}

/* hide copybtn icon on prompts (needed for 'sphinx_copybutton') */
.prompt .copybtn {
    display: none;
}

/* Some additional styling taken form the Jupyter notebook CSS */
div.rendered_html table {
  border: none;
  border-collapse: collapse;
  border-spacing: 0;
  color: black;
  font-size: 12px;
  table-layout: fixed;
}
div.rendered_html thead {
  border-bottom: 1px solid black;
  vertical-align: bottom;
}
div.rendered_html tr,
div.rendered_html th,
div.rendered_html td {
  text-align: right;
  vertical-align: middle;
  padding: 0.5em 0.5em;
  line-height: normal;
  white-space: normal;
  max-width: none;
  border: none;
}
div.rendered_html th {
  font-weight: bold;
}
div.rendered_html tbody tr:nth-child(odd) {
  background: #f5f5f5;
}
div.rendered_html tbody tr:hover {
  background: rgba(66, 165, 245, 0.2);
}

/* CSS overrides for sphinx_rtd_theme */

/* 24px margin */
.nbinput.nblast.container,
.nboutput.nblast.container {
    margin-bottom: 19px;  /* padding has already 5px */
}

/* ... except between code cells! */
.nblast.container + .nbinput.container {
    margin-top: -19px;
}

.admonition > p:before {
    margin-right: 4px;  /* make room for the exclamation icon */
}

/* Fix math alignment, see https://github.com/rtfd/sphinx_rtd_theme/pull/686 */
.math {
    text-align: unset;
}
</style>
<p><img alt="648bfd83646745eeb5a1adc1ae59be36" src="http://developer.download.nvidia.com/compute/machine-learning/frameworks/nvidia_logo.png" /></p>
<div class="section" id="NVTabular-demo-on-RecSys2020-Challenge">
<h1>NVTabular demo on RecSys2020 Challenge<a class="headerlink" href="#NVTabular-demo-on-RecSys2020-Challenge" title="Permalink to this headline"></a></h1>
<div class="section" id="Overview">
<h2>Overview<a class="headerlink" href="#Overview" title="Permalink to this headline"></a></h2>
<p>NVTabular is a feature engineering and preprocessing library for tabular data designed to quickly and easily manipulate terabyte scale datasets used to train deep learning based recommender systems. It provides a high level abstraction to simplify code and accelerates computation on the GPU using the RAPIDS cuDF library.</p>
<div class="section" id="RecSys2020-Challenge">
<h3>RecSys2020 Challenge<a class="headerlink" href="#RecSys2020-Challenge" title="Permalink to this headline"></a></h3>
<p>The <a class="reference external" href="https://recsys.acm.org/">RecSys</a> conference is the leading data science conference for recommender systems and organizes an annual competiton in recommender systems. The <a class="reference external" href="https://recsys-twitter.com/">RecSys Challenge 2020</a>, hosted by Twitter, was about predicting interactions of ~200 mio. tweet-user pairs. NVIDIA’s team scored 1st place. The team explained the solution in the
<a class="reference external" href="https://medium.com/rapids-ai/winning-solution-of-recsys2020-challenge-gpu-accelerated-feature-engineering-and-training-for-cd67c5a87b1f">blogpost</a> and published the code on <a class="reference external" href="https://github.com/rapidsai/deeplearning/tree/main/RecSys2020">github</a>.</p>
</div>
<div class="section" id="Downloading-the-dataset">
<h3>Downloading the dataset<a class="headerlink" href="#Downloading-the-dataset" title="Permalink to this headline"></a></h3>
<p>The dataset has to be downloaded from the original source, provided by Twitter. You need to create an account on the <a class="reference external" href="https://recsys-twitter.com/">RecSys Challenge 2020 website</a>. Twitter needs to (manually) approve your account, which can take a few days. After your account is approved, you can download the data <a class="reference external" href="https://recsys-twitter.com/data/show-downloads">here</a>. We will use only the <code class="docutils literal notranslate"><span class="pre">training.tsv</span></code> file, as we cannot make submissions anymore.</p>
</div>
<div class="section" id="Learning-objectives">
<h3>Learning objectives<a class="headerlink" href="#Learning-objectives" title="Permalink to this headline"></a></h3>
<p>This notebook covers the end-2-end pipeline, from loading the original .tsv file to training the models, with NVTabular, <a class="reference external" href="https://github.com/rapidsai/cudf">cuDF</a>, <a class="reference external" href="https://dask.org/">dask</a> and <a class="reference external" href="https://xgboost.readthedocs.io/">XGBoost</a>. We demonstrate multi-GPU support for NVTabular and new <code class="docutils literal notranslate"><span class="pre">nvt.ops</span></code>, implemented based on the success of our RecSys2020 solution. 1. <strong>NVTabular</strong> to preprocess the original .tsv file. 2. <strong>dask_cudf</strong> to split the preprocessed data into a training and
validation set. 3. <strong>NVTabular</strong> to create additional features with only <strong>~70 lines of code</strong>. 4. <strong>dask_cudf</strong> / <strong>XGBoost on GPU</strong> to train our model.</p>
</div>
</div>
<div class="section" id="Getting-Started">
<h2>Getting Started<a class="headerlink" href="#Getting-Started" title="Permalink to this headline"></a></h2>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[1]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># External Dependencies</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">import</span> <span class="nn">glob</span>
<span class="kn">import</span> <span class="nn">gc</span>

<span class="kn">import</span> <span class="nn">cupy</span> <span class="k">as</span> <span class="nn">cp</span>          <span class="c1"># CuPy is an implementation of NumPy-compatible multi-dimensional array on GPU</span>
<span class="kn">import</span> <span class="nn">cudf</span>                <span class="c1"># cuDF is an implementation of Pandas-like Dataframe on GPU</span>
<span class="kn">import</span> <span class="nn">rmm</span>                 <span class="c1"># library for pre-allocating memory on GPU</span>
<span class="kn">import</span> <span class="nn">dask</span>                <span class="c1"># dask is an open-source library to nateively scale Python on multiple workers/nodes</span>
<span class="kn">import</span> <span class="nn">dask_cudf</span>           <span class="c1"># dask_cudf uses dask to scale cuDF dataframes on multiple workers/nodes</span>

<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="c1"># NVTabular is the core library, we will use here for feature engineering/preprocessing on GPU</span>
<span class="kn">import</span> <span class="nn">nvtabular</span> <span class="k">as</span> <span class="nn">nvt</span>
<span class="kn">import</span> <span class="nn">xgboost</span> <span class="k">as</span> <span class="nn">xgb</span>

<span class="c1"># More dask / dask_cluster related libraries to scale NVTabular</span>
<span class="kn">from</span> <span class="nn">dask_cuda</span> <span class="kn">import</span> <span class="n">LocalCUDACluster</span>
<span class="kn">from</span> <span class="nn">dask.distributed</span> <span class="kn">import</span> <span class="n">Client</span>
<span class="kn">from</span> <span class="nn">dask.distributed</span> <span class="kn">import</span> <span class="n">wait</span>
<span class="kn">from</span> <span class="nn">dask.utils</span> <span class="kn">import</span> <span class="n">parse_bytes</span>
<span class="kn">from</span> <span class="nn">dask.delayed</span> <span class="kn">import</span> <span class="n">delayed</span>
<span class="kn">from</span> <span class="nn">nvtabular.utils</span> <span class="kn">import</span> <span class="n">device_mem_size</span>
</pre></div>
</div>
</div>
<p>Let’s have a short look on the libary versions and setup, we will use.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[2]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">cudf</span><span class="o">.</span><span class="n">__version__</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[2]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
&#39;0+untagged.1.gfa8e9fb&#39;
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[3]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">cp</span><span class="o">.</span><span class="n">__version__</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[3]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
&#39;7.8.0&#39;
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[4]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">xgb</span><span class="o">.</span><span class="n">__version__</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[4]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
&#39;1.2.0-SNAPSHOT&#39;
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[5]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">dask</span><span class="o">.</span><span class="n">__version__</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[5]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
&#39;2.24.0&#39;
</pre></div></div>
</div>
<p>We ran this example with 2x Quadro GV100 GPUs with each having 32GB of GPU memory.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[6]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">!</span>nvidia-smi
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Wed Nov 11 15:39:04 2020
+-----------------------------------------------------------------------------+
| NVIDIA-SMI 450.66       Driver Version: 450.66       CUDA Version: 11.0     |
|-------------------------------+----------------------+----------------------+
| GPU  Name        Persistence-M| Bus-Id        Disp.A | Volatile Uncorr. ECC |
| Fan  Temp  Perf  Pwr:Usage/Cap|         Memory-Usage | GPU-Util  Compute M. |
|                               |                      |               MIG M. |
|===============================+======================+======================|
|   0  Quadro GV100        Off  | 00000000:15:00.0 Off |                  Off |
| 34%   45C    P2    26W / 250W |     13MiB / 32508MiB |      0%      Default |
|                               |                      |                  N/A |
+-------------------------------+----------------------+----------------------+
|   1  Quadro GV100        Off  | 00000000:2D:00.0  On |                  Off |
| 39%   51C    P0    34W / 250W |   1180MiB / 32499MiB |      0%      Default |
|                               |                      |                  N/A |
+-------------------------------+----------------------+----------------------+

+-----------------------------------------------------------------------------+
| Processes:                                                                  |
|  GPU   GI   CI        PID   Type   Process name                  GPU Memory |
|        ID   ID                                                   Usage      |
|=============================================================================|
+-----------------------------------------------------------------------------+
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[7]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">!</span>free
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
              total        used        free      shared  buff/cache   available
Mem:       48020044     5775436    37876780      464524     4367828    41193124
Swap:       1003516     1003444          72
</pre></div></div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[8]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">time_total_start</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
</pre></div>
</div>
</div>
<p>We define our base directory, containing the data.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[9]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">BASE_DIR</span> <span class="o">=</span> <span class="s1">&#39;/raid/data/recsys2020/&#39;</span>
</pre></div>
</div>
</div>
<p>First, we initalize our local cuda cluster.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[10]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">cluster</span> <span class="o">=</span> <span class="n">LocalCUDACluster</span><span class="p">(</span>
    <span class="n">protocol</span><span class="o">=</span><span class="s2">&quot;tcp&quot;</span>
<span class="p">)</span>
<span class="n">client</span> <span class="o">=</span> <span class="n">Client</span><span class="p">(</span><span class="n">cluster</span><span class="p">)</span>
<span class="n">client</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[10]:
</pre></div>
</div>
<div class="output_area rendered_html docutils container">
<table style="border: 2px solid white;">
<tr>
<td style="vertical-align: top; border: 0px solid white">
<h3 style="text-align: left;">Client</h3>
<ul style="text-align: left; list-style: none; margin: 0; padding: 0;">
  <li><b>Scheduler: </b>tcp://127.0.0.1:33697</li>
  <li><b>Dashboard: </b><a href='http://127.0.0.1:8787/status' target='_blank'>http://127.0.0.1:8787/status</a></li>
</ul>
</td>
<td style="vertical-align: top; border: 0px solid white">
<h3 style="text-align: left;">Cluster</h3>
<ul style="text-align: left; list-style:none; margin: 0; padding: 0;">
  <li><b>Workers: </b>2</li>
  <li><b>Cores: </b>2</li>
  <li><b>Memory: </b>49.17 GB</li>
</ul>
</td>
</tr>
</table></div>
</div>
</div>
<div class="section" id="Preparing-our-dataset">
<h2>Preparing our dataset<a class="headerlink" href="#Preparing-our-dataset" title="Permalink to this headline"></a></h2>
<p>The original data format had multiple inefficiencies, resulting in requiring more disk space and memory: 1. The file format is <code class="docutils literal notranslate"><span class="pre">.tsv</span></code>, an uncompressed, column-separated format. The <code class="docutils literal notranslate"><span class="pre">parquet</span></code> file format stores tabular data in a compressed column-oriented format. This saves a significant amount of disk space which results in fewer i/o operations and faster execution. 2. Some categorical features, such as tweet_id, user_id are hashed to String values
(e.g. <code class="docutils literal notranslate"><span class="pre">cfcd208495d565ef66e7dff9f98764da</span></code>). These long Strings require significant amount of disk space/memory. We can encode the Categories as Integer values using <code class="docutils literal notranslate"><span class="pre">Categorify</span></code>. Representing the String <code class="docutils literal notranslate"><span class="pre">cfcd208495d565ef66e7dff9f98764da</span></code> as an Integer <code class="docutils literal notranslate"><span class="pre">0</span></code> can save up 90% in memory. Although other categorical features are no long hashes, they are still Strings (e.g. tweet_type) and we will represent them as Integers, as well. 3. In our experiments, the text_tokens were not a significant
feature and we will drop the column before we split the data.</p>
<p>First, we define the data schema: - features are the column names in the original .tsv file. The .tsv file has no header and we need to specify the names - cat_names are the categorical features, we want to use. - cont_names are the numerical features, we want to use. - label_name contains the target column.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[11]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">features</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s1">&#39;text_tokens&#39;</span><span class="p">,</span>    <span class="c1">###############</span>
    <span class="s1">&#39;hashtags&#39;</span><span class="p">,</span>       <span class="c1">#Tweet Features</span>
    <span class="s1">&#39;tweet_id&#39;</span><span class="p">,</span>       <span class="c1">#</span>
    <span class="s1">&#39;media&#39;</span><span class="p">,</span>          <span class="c1">#</span>
    <span class="s1">&#39;links&#39;</span><span class="p">,</span>          <span class="c1">#</span>
    <span class="s1">&#39;domains&#39;</span><span class="p">,</span>        <span class="c1">#</span>
    <span class="s1">&#39;tweet_type&#39;</span><span class="p">,</span>     <span class="c1">#</span>
    <span class="s1">&#39;language&#39;</span><span class="p">,</span>       <span class="c1">#</span>
    <span class="s1">&#39;timestamp&#39;</span><span class="p">,</span>      <span class="c1">###############</span>
    <span class="s1">&#39;a_user_id&#39;</span><span class="p">,</span>              <span class="c1">###########################</span>
    <span class="s1">&#39;a_follower_count&#39;</span><span class="p">,</span>       <span class="c1">#Engaged With User Features</span>
    <span class="s1">&#39;a_following_count&#39;</span><span class="p">,</span>      <span class="c1">#</span>
    <span class="s1">&#39;a_is_verified&#39;</span><span class="p">,</span>          <span class="c1">#</span>
    <span class="s1">&#39;a_account_creation&#39;</span><span class="p">,</span>     <span class="c1">###########################</span>
    <span class="s1">&#39;b_user_id&#39;</span><span class="p">,</span>              <span class="c1">#######################</span>
    <span class="s1">&#39;b_follower_count&#39;</span><span class="p">,</span>       <span class="c1">#Engaging User Features</span>
    <span class="s1">&#39;b_following_count&#39;</span><span class="p">,</span>      <span class="c1">#</span>
    <span class="s1">&#39;b_is_verified&#39;</span><span class="p">,</span>          <span class="c1">#</span>
    <span class="s1">&#39;b_account_creation&#39;</span><span class="p">,</span>     <span class="c1">#######################</span>
    <span class="s1">&#39;b_follows_a&#39;</span><span class="p">,</span>    <span class="c1">#################### Engagement Features</span>
    <span class="s1">&#39;reply&#39;</span><span class="p">,</span>          <span class="c1">#Target Reply</span>
    <span class="s1">&#39;retweet&#39;</span><span class="p">,</span>        <span class="c1">#Target Retweet</span>
    <span class="s1">&#39;retweet_comment&#39;</span><span class="p">,</span><span class="c1">#Target Retweet with comment</span>
    <span class="s1">&#39;like&#39;</span><span class="p">,</span>           <span class="c1">#Target Like</span>
                      <span class="c1">####################</span>
<span class="p">]</span>

<span class="n">cat_names</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s1">&#39;hashtags&#39;</span><span class="p">,</span>
    <span class="s1">&#39;tweet_id&#39;</span><span class="p">,</span>
    <span class="s1">&#39;media&#39;</span><span class="p">,</span>
    <span class="s1">&#39;links&#39;</span><span class="p">,</span>
    <span class="s1">&#39;domains&#39;</span><span class="p">,</span>
    <span class="s1">&#39;tweet_type&#39;</span><span class="p">,</span>
    <span class="s1">&#39;language&#39;</span><span class="p">,</span>
    <span class="s1">&#39;a_user_id&#39;</span><span class="p">,</span>
    <span class="s1">&#39;a_is_verified&#39;</span><span class="p">,</span>
    <span class="s1">&#39;b_user_id&#39;</span><span class="p">,</span>
    <span class="s1">&#39;b_is_verified&#39;</span><span class="p">,</span>
    <span class="s1">&#39;b_follows_a&#39;</span><span class="p">,</span>

<span class="p">]</span>

<span class="n">cont_names</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s1">&#39;timestamp&#39;</span><span class="p">,</span>
    <span class="s1">&#39;a_follower_count&#39;</span><span class="p">,</span>
    <span class="s1">&#39;a_following_count&#39;</span><span class="p">,</span>
    <span class="s1">&#39;a_account_creation&#39;</span><span class="p">,</span>
    <span class="s1">&#39;b_follower_count&#39;</span><span class="p">,</span>
    <span class="s1">&#39;b_following_count&#39;</span><span class="p">,</span>
    <span class="s1">&#39;b_account_creation&#39;</span>
<span class="p">]</span>

<span class="n">label_name</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s1">&#39;reply&#39;</span><span class="p">,</span>
    <span class="s1">&#39;retweet&#39;</span><span class="p">,</span>
    <span class="s1">&#39;retweet_comment&#39;</span><span class="p">,</span>
    <span class="s1">&#39;like&#39;</span>
<span class="p">]</span>
</pre></div>
</div>
</div>
<p>We initialize our NVTabular workflow.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[12]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">proc</span> <span class="o">=</span> <span class="n">nvt</span><span class="o">.</span><span class="n">Workflow</span><span class="p">(</span><span class="n">cat_names</span><span class="o">=</span><span class="n">cat_names</span><span class="p">,</span>
                    <span class="n">cont_names</span><span class="o">=</span><span class="n">cont_names</span><span class="p">,</span>
                    <span class="n">label_name</span><span class="o">=</span><span class="n">label_name</span><span class="p">)</span>
</pre></div>
</div>
</div>
<p>We define two helper function, we apply in our NVTabular workflow: 1. splitmedia2 splits the entries in media by <code class="docutils literal notranslate"><span class="pre">\t</span></code> and keeps only the first two values (if available), 2. count_token counts the number of token in a column (e.g. how many hashtags are in a tweet),</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[13]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">splitmedia</span><span class="p">(</span><span class="n">col</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">col</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">return</span><span class="p">(</span><span class="n">col</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span><span class="p">(</span><span class="n">col</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="n">col</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">))</span>

<span class="k">def</span> <span class="nf">count_token</span><span class="p">(</span><span class="n">col</span><span class="p">,</span><span class="n">token</span><span class="p">):</span>
    <span class="n">not_null</span> <span class="o">=</span> <span class="n">col</span><span class="o">.</span><span class="n">isnull</span><span class="p">()</span><span class="o">==</span><span class="mi">0</span>
    <span class="k">return</span> <span class="p">((</span><span class="n">col</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="n">token</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">not_null</span><span class="p">)</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
</pre></div>
</div>
</div>
<p>We initialize a nvt.Dataset. The engine is <code class="docutils literal notranslate"><span class="pre">csv</span></code> as the <code class="docutils literal notranslate"><span class="pre">.tsv</span></code> file has a similar structure. The <code class="docutils literal notranslate"><span class="pre">.tsv</span></code> file uses the special character <code class="docutils literal notranslate"><span class="pre">\x01</span></code> to separate columns. There is no header in the file and we define column names with the parameter names.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[14]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">trains_itrs</span> <span class="o">=</span> <span class="n">nvt</span><span class="o">.</span><span class="n">Dataset</span><span class="p">(</span><span class="n">BASE_DIR</span> <span class="o">+</span> <span class="s1">&#39;training.tsv&#39;</span><span class="p">,</span>
                          <span class="n">header</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                          <span class="n">names</span><span class="o">=</span><span class="n">features</span><span class="p">,</span>
                          <span class="n">engine</span><span class="o">=</span><span class="s1">&#39;csv&#39;</span><span class="p">,</span>
                          <span class="n">sep</span><span class="o">=</span><span class="s1">&#39;</span><span class="se">\x01</span><span class="s1">&#39;</span><span class="p">,</span>
                          <span class="n">part_size</span><span class="o">=</span><span class="s1">&#39;1GB&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<p>NVTabular <code class="docutils literal notranslate"><span class="pre">ops</span></code> can be registered in two different ways to a NVTabular <code class="docutils literal notranslate"><span class="pre">workflow</span></code>: Feature or Preprocess. <strong>Features are executed before Preprocess ``ops``.</strong> * The functions <code class="docutils literal notranslate"><span class="pre">add_cat_feature</span></code>, <code class="docutils literal notranslate"><span class="pre">add_cont_feature</span></code> or <code class="docutils literal notranslate"><span class="pre">add_feature</span></code> register an <code class="docutils literal notranslate"><span class="pre">op</span></code> as <strong>feature</strong> * The functions <code class="docutils literal notranslate"><span class="pre">add_cat_preprocess</span></code>, <code class="docutils literal notranslate"><span class="pre">add_cont_preprocess</span></code> or <code class="docutils literal notranslate"><span class="pre">add_preprocess</span></code> register an <code class="docutils literal notranslate"><span class="pre">op</span></code> as <strong>preprocess</strong></p>
<p>We count the number of tokens in the columns hashtags, domains, links. <code class="docutils literal notranslate"><span class="pre">`LambdaOp</span></code> &lt;<a class="reference external" href="https://nvidia.github.io/NVTabular/main/api/ops/lambdaop.html">https://nvidia.github.io/NVTabular/main/api/ops/lambdaop.html</a>&gt;`__ is a special NVTabular operator, which provides an easy way to apply a row-level, user-defined functions to the dataframe.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[15]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">proc</span><span class="o">.</span><span class="n">add_feature</span><span class="p">(</span>
    <span class="n">nvt</span><span class="o">.</span><span class="n">ops</span><span class="o">.</span><span class="n">LambdaOp</span><span class="p">(</span>
        <span class="n">op_name</span><span class="o">=</span><span class="s1">&#39;count_t&#39;</span><span class="p">,</span>
        <span class="n">f</span><span class="o">=</span><span class="k">lambda</span> <span class="n">col</span><span class="p">,</span> <span class="n">gdf</span><span class="p">:</span> <span class="n">count_token</span><span class="p">(</span><span class="n">col</span><span class="p">,</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">&#39;</span><span class="p">),</span>
        <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;hashtags&#39;</span><span class="p">,</span> <span class="s1">&#39;domains&#39;</span><span class="p">,</span> <span class="s1">&#39;links&#39;</span><span class="p">],</span>
        <span class="n">replace</span><span class="o">=</span><span class="kc">False</span>
    <span class="p">)</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
<p>We apply splitmedia function to split the media.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[16]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">proc</span><span class="o">.</span><span class="n">add_feature</span><span class="p">(</span>
    <span class="n">nvt</span><span class="o">.</span><span class="n">ops</span><span class="o">.</span><span class="n">LambdaOp</span><span class="p">(</span>
        <span class="n">op_name</span><span class="o">=</span><span class="s1">&#39;splitmedia&#39;</span><span class="p">,</span>
        <span class="n">f</span><span class="o">=</span><span class="k">lambda</span> <span class="n">col</span><span class="p">,</span> <span class="n">gdf</span><span class="p">:</span> <span class="n">splitmedia</span><span class="p">(</span><span class="n">col</span><span class="p">),</span>
        <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;media&#39;</span><span class="p">],</span>
        <span class="n">replace</span><span class="o">=</span><span class="kc">True</span>
    <span class="p">)</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
<p>We fill in na/missing values in target columns + hashtags, domains, links.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[17]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">proc</span><span class="o">.</span><span class="n">add_feature</span><span class="p">(</span>
    <span class="n">nvt</span><span class="o">.</span><span class="n">ops</span><span class="o">.</span><span class="n">FillMissing</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="n">label_name</span> <span class="o">+</span> <span class="p">[</span><span class="s1">&#39;hashtags&#39;</span><span class="p">,</span> <span class="s1">&#39;domains&#39;</span><span class="p">,</span> <span class="s1">&#39;links&#39;</span><span class="p">])</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
<p>We encode columns as a small, continuous integer to save memory. Some categorical columns contain long hashes of type String as values to preserve the privacy of the users (e.g. userId, language, etc.). Long hashes of type String requires significant amount of memory to store. We encode/map the Strings to continuous Integer to save significant memory.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[18]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">proc</span><span class="o">.</span><span class="n">add_preprocess</span><span class="p">([</span>
    <span class="n">nvt</span><span class="o">.</span><span class="n">ops</span><span class="o">.</span><span class="n">Categorify</span><span class="p">(</span>
        <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;media&#39;</span><span class="p">,</span> <span class="s1">&#39;language&#39;</span><span class="p">,</span> <span class="s1">&#39;tweet_type&#39;</span><span class="p">,</span> <span class="s1">&#39;tweet_id&#39;</span><span class="p">,</span>
                 <span class="s1">&#39;a_user_id&#39;</span><span class="p">,</span> <span class="s1">&#39;b_user_id&#39;</span><span class="p">,</span> <span class="s1">&#39;hashtags&#39;</span><span class="p">,</span> <span class="s1">&#39;domains&#39;</span><span class="p">,</span> <span class="s1">&#39;links&#39;</span><span class="p">]</span>
    <span class="p">)</span>
<span class="p">])</span>
</pre></div>
</div>
</div>
<p>We extract weekday from the timestamp column.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[19]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">proc</span><span class="o">.</span><span class="n">add_preprocess</span><span class="p">(</span>
    <span class="n">nvt</span><span class="o">.</span><span class="n">ops</span><span class="o">.</span><span class="n">LambdaOp</span><span class="p">(</span>
        <span class="n">op_name</span> <span class="o">=</span> <span class="s1">&#39;wd&#39;</span><span class="p">,</span>
        <span class="n">f</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">col</span><span class="p">,</span> <span class="n">gdf</span><span class="p">:</span> <span class="n">cudf</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">col</span><span class="p">,</span> <span class="n">unit</span><span class="o">=</span><span class="s1">&#39;s&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">weekday</span><span class="p">,</span>
        <span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;timestamp&#39;</span><span class="p">],</span>
        <span class="n">replace</span><span class="o">=</span><span class="kc">False</span>
    <span class="p">)</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
<p>We define the output datatypes for continuous columns to save memory. We can define the output datatypes as a dict and parse it to the apply function.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[20]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">dict_dtypes</span> <span class="o">=</span> <span class="p">{}</span>
<span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">label_name</span> <span class="o">+</span> <span class="p">[</span><span class="s1">&#39;media&#39;</span><span class="p">,</span> <span class="s1">&#39;language&#39;</span><span class="p">,</span> <span class="s1">&#39;tweet_type&#39;</span><span class="p">,</span> <span class="s1">&#39;tweet_id&#39;</span><span class="p">,</span>
                         <span class="s1">&#39;a_user_id&#39;</span><span class="p">,</span> <span class="s1">&#39;b_user_id&#39;</span><span class="p">,</span> <span class="s1">&#39;hashtags&#39;</span><span class="p">,</span> <span class="s1">&#39;domains&#39;</span><span class="p">,</span>
                         <span class="s1">&#39;links&#39;</span><span class="p">,</span> <span class="s1">&#39;timestamp&#39;</span><span class="p">,</span> <span class="s1">&#39;a_follower_count&#39;</span><span class="p">,</span>
                         <span class="s1">&#39;a_following_count&#39;</span><span class="p">,</span> <span class="s1">&#39;a_account_creation&#39;</span><span class="p">,</span>
                         <span class="s1">&#39;b_follower_count&#39;</span><span class="p">,</span> <span class="s1">&#39;b_following_count&#39;</span><span class="p">,</span> <span class="s1">&#39;b_account_creation&#39;</span><span class="p">]:</span>
    <span class="n">dict_dtypes</span><span class="p">[</span><span class="n">col</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">uint32</span>
</pre></div>
</div>
</div>
<p>We apply the workflow and save the output to <code class="docutils literal notranslate"><span class="pre">preprocess/</span></code>.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[21]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%%time</span>

<span class="n">time_preproc_start</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
<span class="n">proc</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">trains_itrs</span><span class="p">,</span> <span class="n">record_stats</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">output_path</span><span class="o">=</span><span class="n">BASE_DIR</span> <span class="o">+</span> <span class="s1">&#39;preprocess/&#39;</span><span class="p">,</span> <span class="n">dtypes</span><span class="o">=</span><span class="n">dict_dtypes</span><span class="p">)</span>
<span class="n">time_preproc</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span><span class="o">-</span><span class="n">time_preproc_start</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
/opt/conda/envs/rapids/lib/python3.7/site-packages/cudf/core/column/string.py:1992: UserWarning: `expand` parameter defatults to True.
  warnings.warn(&#34;`expand` parameter defatults to True.&#34;)
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
CPU times: user 2min 43s, sys: 1min 29s, total: 4min 13s
Wall time: 5min 37s
</pre></div></div>
</div>
<p>We can take a look in the output folder.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[22]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">!</span>ls <span class="nv">$BASE_DIR</span>/preprocess
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
_metadata        part.2.parquet   part.31.parquet  part.43.parquet
part.0.parquet   part.20.parquet  part.32.parquet  part.44.parquet
part.1.parquet   part.21.parquet  part.33.parquet  part.45.parquet
part.10.parquet  part.22.parquet  part.34.parquet  part.46.parquet
part.11.parquet  part.23.parquet  part.35.parquet  part.47.parquet
part.12.parquet  part.24.parquet  part.36.parquet  part.48.parquet
part.13.parquet  part.25.parquet  part.37.parquet  part.5.parquet
part.14.parquet  part.26.parquet  part.38.parquet  part.6.parquet
part.15.parquet  part.27.parquet  part.39.parquet  part.7.parquet
part.16.parquet  part.28.parquet  part.4.parquet   part.8.parquet
part.17.parquet  part.29.parquet  part.40.parquet  part.9.parquet
part.18.parquet  part.3.parquet   part.41.parquet
part.19.parquet  part.30.parquet  part.42.parquet
</pre></div></div>
</div>
</div>
<div class="section" id="Splitting-dataset-into-training-and-test">
<h2>Splitting dataset into training and test<a class="headerlink" href="#Splitting-dataset-into-training-and-test" title="Permalink to this headline"></a></h2>
<p>We split the training data by time into a train and validation set. The first 5 days are train and the last 2 days are for validation. We use the weekday for it. The first day of the dataset is a Thursday (weekday id = 3) and the last day is Wednesday (weekday id = 2). Therefore, we split the weekday ids 1 and 2 into the validation set.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[23]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%%time</span>

<span class="n">time_split_start</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>

<span class="n">df</span> <span class="o">=</span> <span class="n">dask_cudf</span><span class="o">.</span><span class="n">read_parquet</span><span class="p">(</span><span class="n">BASE_DIR</span> <span class="o">+</span> <span class="s1">&#39;preprocess/*.parquet&#39;</span><span class="p">)</span>
<span class="k">if</span> <span class="s1">&#39;text_tokens&#39;</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">):</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="s1">&#39;text_tokens&#39;</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">VALID_DOW</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span>

<span class="n">valid</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;timestamp_wd&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">VALID_DOW</span><span class="p">)]</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">train</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="o">~</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;timestamp_wd&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">VALID_DOW</span><span class="p">)]</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">train</span> <span class="o">=</span> <span class="n">train</span><span class="o">.</span><span class="n">sort_values</span><span class="p">([</span><span class="s2">&quot;b_user_id&quot;</span><span class="p">,</span> <span class="s2">&quot;timestamp&quot;</span><span class="p">])</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">valid</span> <span class="o">=</span> <span class="n">valid</span><span class="o">.</span><span class="n">sort_values</span><span class="p">([</span><span class="s2">&quot;b_user_id&quot;</span><span class="p">,</span> <span class="s2">&quot;timestamp&quot;</span><span class="p">])</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">train</span><span class="o">.</span><span class="n">to_parquet</span><span class="p">(</span><span class="n">BASE_DIR</span> <span class="o">+</span> <span class="s1">&#39;nv_train/&#39;</span><span class="p">)</span>
<span class="n">valid</span><span class="o">.</span><span class="n">to_parquet</span><span class="p">(</span><span class="n">BASE_DIR</span> <span class="o">+</span> <span class="s1">&#39;nv_valid/&#39;</span><span class="p">)</span>
<span class="n">time_split</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span><span class="o">-</span><span class="n">time_split_start</span>

<span class="k">del</span> <span class="n">train</span><span class="p">;</span> <span class="k">del</span> <span class="n">valid</span>
<span class="n">gc</span><span class="o">.</span><span class="n">collect</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
CPU times: user 11.2 s, sys: 26.7 ms, total: 11.2 s
Wall time: 2min 2s
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[23]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
458
</pre></div></div>
</div>
</div>
<div class="section" id="Feature-Engineering">
<h2>Feature Engineering<a class="headerlink" href="#Feature-Engineering" title="Permalink to this headline"></a></h2>
<p>Now, we can apply the actual feature engineering. First, we define the data schema, again.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[24]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">!</span>nvidia-smi
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Wed Nov 11 15:46:49 2020
+-----------------------------------------------------------------------------+
| NVIDIA-SMI 450.66       Driver Version: 450.66       CUDA Version: 11.0     |
|-------------------------------+----------------------+----------------------+
| GPU  Name        Persistence-M| Bus-Id        Disp.A | Volatile Uncorr. ECC |
| Fan  Temp  Perf  Pwr:Usage/Cap|         Memory-Usage | GPU-Util  Compute M. |
|                               |                      |               MIG M. |
|===============================+======================+======================|
|   0  Quadro GV100        Off  | 00000000:15:00.0 Off |                  Off |
| 42%   54C    P2    49W / 250W |   1477MiB / 32508MiB |      0%      Default |
|                               |                      |                  N/A |
+-------------------------------+----------------------+----------------------+
|   1  Quadro GV100        Off  | 00000000:2D:00.0  On |                  Off |
| 44%   59C    P2    48W / 250W |   1885MiB / 32499MiB |      0%      Default |
|                               |                      |                  N/A |
+-------------------------------+----------------------+----------------------+

+-----------------------------------------------------------------------------+
| Processes:                                                                  |
|  GPU   GI   CI        PID   Type   Process name                  GPU Memory |
|        ID   ID                                                   Usage      |
|=============================================================================|
+-----------------------------------------------------------------------------+
</pre></div></div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[25]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">CATEGORICAL_COLUMNS</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s1">&#39;hashtags&#39;</span><span class="p">,</span> <span class="s1">&#39;tweet_id&#39;</span><span class="p">,</span> <span class="s1">&#39;media&#39;</span><span class="p">,</span> <span class="s1">&#39;links&#39;</span><span class="p">,</span> <span class="s1">&#39;domains&#39;</span><span class="p">,</span> <span class="s1">&#39;tweet_type&#39;</span><span class="p">,</span> <span class="s1">&#39;language&#39;</span><span class="p">,</span>
    <span class="s1">&#39;a_user_id&#39;</span><span class="p">,</span> <span class="s1">&#39;a_is_verified&#39;</span><span class="p">,</span>
    <span class="s1">&#39;b_user_id&#39;</span><span class="p">,</span> <span class="s1">&#39;b_is_verified&#39;</span><span class="p">,</span>
    <span class="s1">&#39;b_follows_a&#39;</span><span class="p">,</span> <span class="s1">&#39;timestamp_wd&#39;</span>
<span class="p">]</span>

<span class="n">CONTINUOUS_COLUMNS</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s1">&#39;timestamp&#39;</span><span class="p">,</span>
    <span class="s1">&#39;a_follower_count&#39;</span><span class="p">,</span> <span class="s1">&#39;a_following_count&#39;</span><span class="p">,</span>
    <span class="s1">&#39;b_follower_count&#39;</span><span class="p">,</span> <span class="s1">&#39;b_following_count&#39;</span><span class="p">,</span>
    <span class="s1">&#39;hashtags_count_t&#39;</span><span class="p">,</span> <span class="s1">&#39;domains_count_t&#39;</span><span class="p">,</span> <span class="s1">&#39;links_count_t&#39;</span>
<span class="p">]</span>
<span class="n">LABEL_COLUMNS</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s1">&#39;reply&#39;</span><span class="p">,</span> <span class="s1">&#39;retweet&#39;</span><span class="p">,</span> <span class="s1">&#39;retweet_comment&#39;</span><span class="p">,</span> <span class="s1">&#39;like&#39;</span>
<span class="p">]</span>
<br/></pre></div>
</div>
</div>
<p>We initalize the NVTabular workflow.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[26]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">proc</span> <span class="o">=</span> <span class="n">nvt</span><span class="o">.</span><span class="n">Workflow</span><span class="p">(</span>
    <span class="n">cat_names</span><span class="o">=</span><span class="n">CATEGORICAL_COLUMNS</span><span class="p">,</span>
    <span class="n">cont_names</span><span class="o">=</span><span class="n">CONTINUOUS_COLUMNS</span><span class="p">,</span>
    <span class="n">label_name</span><span class="o">=</span><span class="n">LABEL_COLUMNS</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
<p>We apply TargetEncoding with kfold of 5 and smoothing of 20. TargetEncoding is explained in <a class="reference external" href="https://medium.com/rapids-ai/target-encoding-with-rapids-cuml-do-more-with-your-categorical-data-8c762c79e784">here</a> and <a class="reference external" href="https://github.com/rapidsai/deeplearning/blob/main/RecSys2020Tutorial/03_3_TargetEncoding.ipynb">here</a>. We need to transform the LABEL_COLUMNS into boolean (0/1) targets.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[27]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">proc</span><span class="o">.</span><span class="n">add_feature</span><span class="p">(</span>
    <span class="p">[</span><span class="n">nvt</span><span class="o">.</span><span class="n">ops</span><span class="o">.</span><span class="n">LambdaOp</span><span class="p">(</span>
        <span class="n">op_name</span> <span class="o">=</span> <span class="s1">&#39;change&#39;</span><span class="p">,</span>
        <span class="n">f</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">col</span><span class="p">,</span> <span class="n">gdf</span><span class="p">:</span> <span class="p">(</span><span class="n">col</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;int8&#39;</span><span class="p">),</span>
        <span class="n">columns</span> <span class="o">=</span> <span class="n">LABEL_COLUMNS</span><span class="p">,</span>
        <span class="n">replace</span><span class="o">=</span><span class="kc">True</span>
    <span class="p">),</span>
     <span class="n">nvt</span><span class="o">.</span><span class="n">ops</span><span class="o">.</span><span class="n">TargetEncoding</span><span class="p">(</span>
        <span class="n">cat_groups</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;media&#39;</span><span class="p">,</span>
                      <span class="s1">&#39;tweet_type&#39;</span><span class="p">,</span>
                      <span class="s1">&#39;language&#39;</span><span class="p">,</span>
                      <span class="s1">&#39;a_user_id&#39;</span><span class="p">,</span>
                      <span class="s1">&#39;b_user_id&#39;</span><span class="p">,</span>
                      <span class="p">[</span><span class="s1">&#39;domains&#39;</span><span class="p">,</span><span class="s1">&#39;language&#39;</span><span class="p">,</span><span class="s1">&#39;b_follows_a&#39;</span><span class="p">,</span><span class="s1">&#39;tweet_type&#39;</span><span class="p">,</span><span class="s1">&#39;media&#39;</span><span class="p">,</span><span class="s1">&#39;a_is_verified&#39;</span><span class="p">]],</span>
        <span class="n">cont_target</span> <span class="o">=</span> <span class="n">LABEL_COLUMNS</span><span class="p">,</span>
        <span class="n">kfold</span> <span class="o">=</span> <span class="mi">5</span><span class="p">,</span>
        <span class="n">p_smooth</span> <span class="o">=</span> <span class="mi">20</span>
    <span class="p">)]</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
<p>We count encode the columns <em>media</em>, <em>tweet_type</em>, <em>language</em>, <em>a_user_id</em>, <em>b_user_id</em>. CountEncoding is explained <a class="reference external" href="https://github.com/rapidsai/deeplearning/blob/main/RecSys2020Tutorial/03_4_CountEncoding.ipynb">here</a>.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[28]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">proc</span><span class="o">.</span><span class="n">add_preprocess</span><span class="p">(</span>
    <span class="n">nvt</span><span class="o">.</span><span class="n">ops</span><span class="o">.</span><span class="n">JoinGroupby</span><span class="p">(</span>
        <span class="n">columns</span> <span class="o">=</span> <span class="p">[</span>
            <span class="s1">&#39;media&#39;</span><span class="p">,</span>
            <span class="s1">&#39;tweet_type&#39;</span><span class="p">,</span>
            <span class="s1">&#39;language&#39;</span><span class="p">,</span>
            <span class="s1">&#39;a_user_id&#39;</span><span class="p">,</span>
            <span class="s1">&#39;b_user_id&#39;</span>
        <span class="p">]</span>
    <span class="p">)</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
<p>We transform timestamp to datetime type.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[29]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">proc</span><span class="o">.</span><span class="n">add_preprocess</span><span class="p">(</span>
    <span class="n">nvt</span><span class="o">.</span><span class="n">ops</span><span class="o">.</span><span class="n">LambdaOp</span><span class="p">(</span>
        <span class="n">op_name</span> <span class="o">=</span> <span class="s1">&#39;to_datetime&#39;</span><span class="p">,</span>
        <span class="n">f</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">col</span><span class="p">,</span> <span class="n">gdf</span><span class="p">:</span> <span class="n">cudf</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">col</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;int32&#39;</span><span class="p">),</span> <span class="n">unit</span><span class="o">=</span><span class="s1">&#39;s&#39;</span><span class="p">),</span>
        <span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;timestamp&#39;</span><span class="p">],</span>
        <span class="n">replace</span><span class="o">=</span><span class="kc">False</span>
    <span class="p">)</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
<p>We extract hour from datetime. We extract minute from datetime. We extract seconds from datetime</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[30]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">proc</span><span class="o">.</span><span class="n">add_preprocess</span><span class="p">(</span>
    <span class="n">nvt</span><span class="o">.</span><span class="n">ops</span><span class="o">.</span><span class="n">LambdaOp</span><span class="p">(</span>
        <span class="n">op_name</span> <span class="o">=</span> <span class="s1">&#39;to_hour&#39;</span><span class="p">,</span>
        <span class="n">f</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">col</span><span class="p">,</span> <span class="n">gdf</span><span class="p">:</span> <span class="n">col</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">hour</span><span class="p">,</span>
        <span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;timestamp_to_datetime&#39;</span><span class="p">],</span>
        <span class="n">replace</span><span class="o">=</span><span class="kc">False</span>
    <span class="p">)</span>
<span class="p">)</span>
<span class="n">proc</span><span class="o">.</span><span class="n">add_preprocess</span><span class="p">(</span>
    <span class="n">nvt</span><span class="o">.</span><span class="n">ops</span><span class="o">.</span><span class="n">LambdaOp</span><span class="p">(</span>
        <span class="n">op_name</span> <span class="o">=</span> <span class="s1">&#39;to_minute&#39;</span><span class="p">,</span>
        <span class="n">f</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">col</span><span class="p">,</span> <span class="n">gdf</span><span class="p">:</span> <span class="n">col</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">minute</span><span class="p">,</span>
        <span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;timestamp_to_datetime&#39;</span><span class="p">],</span>
        <span class="n">replace</span><span class="o">=</span><span class="kc">False</span>
    <span class="p">)</span>
<span class="p">)</span>
<span class="n">proc</span><span class="o">.</span><span class="n">add_preprocess</span><span class="p">(</span>
    <span class="n">nvt</span><span class="o">.</span><span class="n">ops</span><span class="o">.</span><span class="n">LambdaOp</span><span class="p">(</span>
        <span class="n">op_name</span> <span class="o">=</span> <span class="s1">&#39;to_second&#39;</span><span class="p">,</span>
        <span class="n">f</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">col</span><span class="p">,</span> <span class="n">gdf</span><span class="p">:</span> <span class="n">col</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">second</span><span class="p">,</span>
        <span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;timestamp_to_datetime&#39;</span><span class="p">],</span>
        <span class="n">replace</span><span class="o">=</span><span class="kc">False</span>
    <span class="p">)</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
<p>We difference encode <em>b_follower_count, b_following_count, language</em> grouped by <em>b_user_id</em>. DifferenceEncoding is explained <a class="reference external" href="https://github.com/rapidsai/tdeeplearning/blob/main/RecSys2020Tutorial/05_2_TimeSeries_Differences.ipynb">here</a>. First, we need to transform the datatype to float32 to prevent overflow/underflow. After DifferenceEncoding, we want to fill NaN values with 0.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[31]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">proc</span><span class="o">.</span><span class="n">add_preprocess</span><span class="p">([</span>
    <span class="n">nvt</span><span class="o">.</span><span class="n">ops</span><span class="o">.</span><span class="n">LambdaOp</span><span class="p">(</span>
        <span class="n">op_name</span> <span class="o">=</span> <span class="s1">&#39;asfloat&#39;</span><span class="p">,</span>
        <span class="n">f</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">col</span><span class="p">,</span> <span class="n">gdf</span><span class="p">:</span> <span class="n">col</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;float32&#39;</span><span class="p">),</span>
        <span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;b_follower_count&#39;</span><span class="p">,</span><span class="s1">&#39;b_following_count&#39;</span><span class="p">,</span><span class="s1">&#39;language&#39;</span><span class="p">],</span>
        <span class="n">replace</span><span class="o">=</span><span class="kc">True</span>
    <span class="p">),</span>
    <span class="n">nvt</span><span class="o">.</span><span class="n">ops</span><span class="o">.</span><span class="n">DifferenceLag</span><span class="p">(</span>
        <span class="s1">&#39;b_user_id&#39;</span><span class="p">,</span>
        <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;b_follower_count&#39;</span><span class="p">,</span><span class="s1">&#39;b_following_count&#39;</span><span class="p">,</span><span class="s1">&#39;language&#39;</span><span class="p">],</span>
        <span class="n">shift</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="p">),</span>
    <span class="n">nvt</span><span class="o">.</span><span class="n">ops</span><span class="o">.</span><span class="n">FillMissing</span><span class="p">(</span><span class="n">fill_val</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="p">])</span>
</pre></div>
</div>
</div>
<p>We initialize the train and valid as NVTabular datasets.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[32]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">train_dataset</span> <span class="o">=</span> <span class="n">nvt</span><span class="o">.</span><span class="n">Dataset</span><span class="p">(</span><span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="n">BASE_DIR</span> <span class="o">+</span> <span class="s1">&#39;nv_train/*.parquet&#39;</span><span class="p">),</span>
                            <span class="n">engine</span><span class="o">=</span><span class="s1">&#39;parquet&#39;</span><span class="p">,</span>
                            <span class="n">part_size</span><span class="o">=</span><span class="s2">&quot;2GB&quot;</span><span class="p">)</span>
<span class="n">valid_dataset</span> <span class="o">=</span> <span class="n">nvt</span><span class="o">.</span><span class="n">Dataset</span><span class="p">(</span><span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="n">BASE_DIR</span> <span class="o">+</span> <span class="s1">&#39;nv_valid/*.parquet&#39;</span><span class="p">),</span>
                            <span class="n">engine</span><span class="o">=</span><span class="s1">&#39;parquet&#39;</span><span class="p">,</span>
                            <span class="n">part_size</span><span class="o">=</span><span class="s2">&quot;2GB&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<p>The columns <em>a_is_verified</em>, <em>b_is_verified</em> and <em>b_follows_a</em> have the datatype boolean. XGBoost does not support boolean datatypes and we need convert them to int8. We can define the output datatypes as a dict and parse it to the apply function.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[33]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">dict_dtypes</span> <span class="o">=</span> <span class="p">{}</span>
<span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;a_is_verified&#39;</span><span class="p">,</span><span class="s1">&#39;b_is_verified&#39;</span><span class="p">,</span><span class="s1">&#39;b_follows_a&#39;</span><span class="p">]:</span>
    <span class="n">dict_dtypes</span><span class="p">[</span><span class="n">col</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">int8</span>
</pre></div>
</div>
</div>
<p>We apply the workflow to the datasets.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[34]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%%time</span>

<span class="n">time_fe_start</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
<span class="n">proc</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">train_dataset</span><span class="p">,</span> <span class="n">record_stats</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">output_path</span><span class="o">=</span><span class="n">BASE_DIR</span> <span class="o">+</span> <span class="s1">&#39;nv_train_fe/&#39;</span><span class="p">,</span> <span class="n">dtypes</span><span class="o">=</span><span class="n">dict_dtypes</span><span class="p">)</span>
<span class="n">proc</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">valid_dataset</span><span class="p">,</span> <span class="n">record_stats</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">output_path</span><span class="o">=</span><span class="n">BASE_DIR</span> <span class="o">+</span> <span class="s1">&#39;nv_valid_fe/&#39;</span><span class="p">,</span> <span class="n">dtypes</span><span class="o">=</span><span class="n">dict_dtypes</span><span class="p">)</span>
<span class="n">time_fe</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span><span class="o">-</span><span class="n">time_fe_start</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
/opt/conda/envs/rapids/lib/python3.7/site-packages/cudf/core/join/join.py:368: UserWarning: can&#39;t safely cast column from right with type int64 to uint32, upcasting to int64
  &#34;right&#34;, dtype_r, dtype_l, libcudf_join_type
/opt/conda/envs/rapids/lib/python3.7/site-packages/dask/dataframe/io/parquet/core.py:414: UserWarning: If read back by Dask, column named __null_dask_index__ will be set to the index (and renamed to None).
  &#34;If read back by Dask, column named __null_dask_index__ &#34;
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
CPU times: user 2min 27s, sys: 1min 20s, total: 3min 48s
Wall time: 3min 54s
</pre></div></div>
</div>
</div>
<div class="section" id="Training-our-model">
<h2>Training our model<a class="headerlink" href="#Training-our-model" title="Permalink to this headline"></a></h2>
<p>After the preprocessing and feature engineering is done, we can train a model to predict our targets. We load our datasets with <code class="docutils literal notranslate"><span class="pre">dask_cudf</span></code>.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[35]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">train</span> <span class="o">=</span> <span class="n">dask_cudf</span><span class="o">.</span><span class="n">read_parquet</span><span class="p">(</span><span class="n">BASE_DIR</span> <span class="o">+</span> <span class="s1">&#39;nv_train_fe/*.parquet&#39;</span><span class="p">)</span>
<span class="n">valid</span> <span class="o">=</span> <span class="n">dask_cudf</span><span class="o">.</span><span class="n">read_parquet</span><span class="p">(</span><span class="n">BASE_DIR</span> <span class="o">+</span> <span class="s1">&#39;nv_valid_fe/*.parquet&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[36]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">train</span><span class="p">[[</span><span class="s1">&#39;a_is_verified&#39;</span><span class="p">,</span><span class="s1">&#39;b_is_verified&#39;</span><span class="p">,</span><span class="s1">&#39;b_follows_a&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">dtypes</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[36]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
a_is_verified    int8
b_is_verified    int8
b_follows_a      int8
dtype: object
</pre></div></div>
</div>
<p>Some columns are only used for feature engineering. Therefore, we define the columns we want to ignore for training.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[37]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">dont_use</span> <span class="o">=</span><span class="p">[</span>
    <span class="s1">&#39;__null_dask_index__&#39;</span><span class="p">,</span>
    <span class="s1">&#39;text_tokens&#39;</span><span class="p">,</span>
    <span class="s1">&#39;timestamp&#39;</span><span class="p">,</span>
    <span class="s1">&#39;a_account_creation&#39;</span><span class="p">,</span>
    <span class="s1">&#39;b_account_creation&#39;</span><span class="p">,</span>
    <span class="s1">&#39;hashtags&#39;</span><span class="p">,</span>
    <span class="s1">&#39;tweet_id&#39;</span><span class="p">,</span>
    <span class="s1">&#39;links&#39;</span><span class="p">,</span>
    <span class="s1">&#39;domains&#39;</span><span class="p">,</span>
    <span class="s1">&#39;a_user_id&#39;</span><span class="p">,</span>
    <span class="s1">&#39;b_user_id&#39;</span><span class="p">,</span>
    <span class="s1">&#39;timestamp_wd&#39;</span><span class="p">,</span>
    <span class="s1">&#39;timestamp_to_datetime&#39;</span><span class="p">,</span>
    <span class="s1">&#39;a_following_count_a_ff_rate&#39;</span><span class="p">,</span>
    <span class="s1">&#39;b_following_count_b_ff_rate&#39;</span>
<span class="p">]</span>
<span class="n">dont_use</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">train</span><span class="o">.</span><span class="n">columns</span> <span class="k">if</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">dont_use</span><span class="p">]</span>
<span class="n">label_names</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;reply&#39;</span><span class="p">,</span> <span class="s1">&#39;retweet&#39;</span><span class="p">,</span> <span class="s1">&#39;retweet_comment&#39;</span><span class="p">,</span> <span class="s1">&#39;like&#39;</span><span class="p">]</span>
</pre></div>
</div>
</div>
<p>We drop the columns, which are not required for training.</p>
<p>Our experiments show that we require only 10% of the training dataset. Our feature engineering, such as TargetEncoding, uses the training datasets and leverage the information of the full dataset. In the competition, we trained our models with higher ratio (20% and 50%), but we could not observe an improvement in performance. We sample the training dataset to 10% of the size and drop all columns, which we do not want to use.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[38]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">SAMPLE_RATIO</span> <span class="o">=</span> <span class="mf">0.1</span>
<span class="n">SEED</span> <span class="o">=</span> <span class="mi">1</span>

<span class="k">if</span> <span class="n">SAMPLE_RATIO</span> <span class="o">&lt;</span> <span class="mf">1.0</span><span class="p">:</span>
    <span class="n">train</span><span class="p">[</span><span class="s1">&#39;sample&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">train</span><span class="p">[</span><span class="s1">&#39;tweet_id&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">map_partitions</span><span class="p">(</span><span class="k">lambda</span> <span class="n">cudf_df</span><span class="p">:</span> <span class="n">cudf_df</span><span class="o">.</span><span class="n">hash_encode</span><span class="p">(</span><span class="n">stop</span><span class="o">=</span><span class="mi">10</span><span class="p">))</span>
    <span class="nb">print</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">train</span><span class="p">))</span>

    <span class="n">train</span> <span class="o">=</span> <span class="n">train</span><span class="p">[</span><span class="n">train</span><span class="p">[</span><span class="s1">&#39;sample&#39;</span><span class="p">]</span><span class="o">&lt;</span><span class="mi">10</span><span class="o">*</span><span class="n">SAMPLE_RATIO</span><span class="p">]</span>
    <span class="n">train</span><span class="p">,</span> <span class="o">=</span> <span class="n">dask</span><span class="o">.</span><span class="n">persist</span><span class="p">(</span><span class="n">train</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">train</span><span class="p">))</span>


<span class="n">Y_train</span> <span class="o">=</span> <span class="n">train</span><span class="p">[</span><span class="n">label_names</span><span class="p">]</span>
<span class="n">Y_train</span><span class="p">,</span> <span class="o">=</span> <span class="n">dask</span><span class="o">.</span><span class="n">persist</span><span class="p">(</span><span class="n">Y_train</span><span class="p">)</span>

<span class="n">train</span> <span class="o">=</span> <span class="n">train</span><span class="o">.</span><span class="n">drop</span><span class="p">([</span><span class="s1">&#39;sample&#39;</span><span class="p">]</span><span class="o">+</span><span class="n">label_names</span><span class="o">+</span><span class="n">dont_use</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">train</span><span class="p">,</span> <span class="o">=</span> <span class="n">dask</span><span class="o">.</span><span class="n">persist</span><span class="p">(</span><span class="n">train</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Using </span><span class="si">%i</span><span class="s1"> features&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">train</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
67513999
6771556
Using 51 features
</pre></div></div>
</div>
<p>Similar to the training dataset, our experiments show that 35% of our validation dataset is enough to get a good estimate of the performance metric. 35% of the validation dataset has a similar size as the test set of the RecSys2020 competition.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[39]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">SAMPLE_RATIO</span> <span class="o">=</span> <span class="mf">0.35</span>
<span class="n">SEED</span> <span class="o">=</span> <span class="mi">1</span>
<span class="k">if</span> <span class="n">SAMPLE_RATIO</span> <span class="o">&lt;</span> <span class="mf">1.0</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">valid</span><span class="p">))</span>
    <span class="n">valid</span><span class="p">[</span><span class="s1">&#39;sample&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">valid</span><span class="p">[</span><span class="s1">&#39;tweet_id&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">map_partitions</span><span class="p">(</span><span class="k">lambda</span> <span class="n">cudf_df</span><span class="p">:</span> <span class="n">cudf_df</span><span class="o">.</span><span class="n">hash_encode</span><span class="p">(</span><span class="n">stop</span><span class="o">=</span><span class="mi">10</span><span class="p">))</span>

    <span class="n">valid</span> <span class="o">=</span> <span class="n">valid</span><span class="p">[</span><span class="n">valid</span><span class="p">[</span><span class="s1">&#39;sample&#39;</span><span class="p">]</span><span class="o">&lt;</span><span class="mi">10</span><span class="o">*</span><span class="n">SAMPLE_RATIO</span><span class="p">]</span>
    <span class="n">valid</span><span class="p">,</span> <span class="o">=</span> <span class="n">dask</span><span class="o">.</span><span class="n">persist</span><span class="p">(</span><span class="n">valid</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">valid</span><span class="p">))</span>

<span class="n">Y_valid</span> <span class="o">=</span> <span class="n">valid</span><span class="p">[</span><span class="n">label_names</span><span class="p">]</span>
<span class="n">Y_valid</span><span class="p">,</span> <span class="o">=</span> <span class="n">dask</span><span class="o">.</span><span class="n">persist</span><span class="p">(</span><span class="n">Y_valid</span><span class="p">)</span>

<span class="n">valid</span> <span class="o">=</span> <span class="n">valid</span><span class="o">.</span><span class="n">drop</span><span class="p">([</span><span class="s1">&#39;sample&#39;</span><span class="p">]</span><span class="o">+</span><span class="n">label_names</span><span class="o">+</span><span class="n">dont_use</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">valid</span><span class="p">,</span> <span class="o">=</span> <span class="n">dask</span><span class="o">.</span><span class="n">persist</span><span class="p">(</span><span class="n">valid</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
25814765
10320615
</pre></div></div>
</div>
<p>We initialize our XGBoost parameter.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[40]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="s1">&#39;XGB Version&#39;</span><span class="p">,</span><span class="n">xgb</span><span class="o">.</span><span class="n">__version__</span><span class="p">)</span>

<span class="n">xgb_parms</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;max_depth&#39;</span><span class="p">:</span><span class="mi">8</span><span class="p">,</span>
    <span class="s1">&#39;learning_rate&#39;</span><span class="p">:</span><span class="mf">0.1</span><span class="p">,</span>
    <span class="s1">&#39;subsample&#39;</span><span class="p">:</span><span class="mf">0.8</span><span class="p">,</span>
    <span class="s1">&#39;colsample_bytree&#39;</span><span class="p">:</span><span class="mf">0.3</span><span class="p">,</span>
    <span class="s1">&#39;eval_metric&#39;</span><span class="p">:</span><span class="s1">&#39;logloss&#39;</span><span class="p">,</span>
    <span class="s1">&#39;objective&#39;</span><span class="p">:</span><span class="s1">&#39;binary:logistic&#39;</span><span class="p">,</span>
    <span class="s1">&#39;tree_method&#39;</span><span class="p">:</span><span class="s1">&#39;gpu_hist&#39;</span><span class="p">,</span>
    <span class="s1">&#39;predictor&#39;</span> <span class="p">:</span> <span class="s1">&#39;gpu_predictor&#39;</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
XGB Version 1.2.0-SNAPSHOT
</pre></div></div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[41]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">train</span><span class="p">,</span><span class="n">valid</span> <span class="o">=</span> <span class="n">dask</span><span class="o">.</span><span class="n">persist</span><span class="p">(</span><span class="n">train</span><span class="p">,</span><span class="n">valid</span><span class="p">)</span>
</pre></div>
</div>
</div>
<p>We train our XGBoost models. The challenge requires to predict 4 targets, does a user 1. like a tweet 2. reply a tweet 3. comment a tweet 4. comment and reply a tweet</p>
<p>We train 4x XGBoost models for 300 rounds on a GPU.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[42]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%%time</span>
<span class="n">time_train_start</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>

<span class="n">NROUND</span> <span class="o">=</span> <span class="mi">300</span>
<span class="n">VERBOSE_EVAL</span> <span class="o">=</span> <span class="mi">50</span>
<span class="n">preds</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">4</span><span class="p">):</span>

    <span class="n">name</span> <span class="o">=</span> <span class="n">label_names</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;#&#39;</span><span class="o">*</span><span class="mi">25</span><span class="p">);</span><span class="nb">print</span><span class="p">(</span><span class="s1">&#39;###&#39;</span><span class="p">,</span><span class="n">name</span><span class="p">);</span><span class="nb">print</span><span class="p">(</span><span class="s1">&#39;#&#39;</span><span class="o">*</span><span class="mi">25</span><span class="p">)</span>

    <span class="n">start</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">();</span> <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Creating DMatrix...&#39;</span><span class="p">)</span>
    <span class="n">dtrain</span> <span class="o">=</span> <span class="n">xgb</span><span class="o">.</span><span class="n">dask</span><span class="o">.</span><span class="n">DaskDMatrix</span><span class="p">(</span><span class="n">client</span><span class="p">,</span><span class="n">data</span><span class="o">=</span><span class="n">train</span><span class="p">,</span><span class="n">label</span><span class="o">=</span><span class="n">Y_train</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,</span> <span class="n">i</span><span class="p">])</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Took </span><span class="si">%.1f</span><span class="s1"> seconds&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span><span class="o">-</span><span class="n">start</span><span class="p">))</span>

    <span class="n">start</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">();</span> <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Training...&#39;</span><span class="p">)</span>
    <span class="n">model</span> <span class="o">=</span> <span class="n">xgb</span><span class="o">.</span><span class="n">dask</span><span class="o">.</span><span class="n">train</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">xgb_parms</span><span class="p">,</span>
                           <span class="n">dtrain</span><span class="o">=</span><span class="n">dtrain</span><span class="p">,</span>
                           <span class="n">num_boost_round</span><span class="o">=</span><span class="n">NROUND</span><span class="p">,</span>
                           <span class="n">verbose_eval</span><span class="o">=</span><span class="n">VERBOSE_EVAL</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Took </span><span class="si">%.1f</span><span class="s1"> seconds&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span><span class="o">-</span><span class="n">start</span><span class="p">))</span>

    <span class="n">start</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">();</span> <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Predicting...&#39;</span><span class="p">)</span>
    <span class="n">preds</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">xgb</span><span class="o">.</span><span class="n">dask</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">client</span><span class="p">,</span><span class="n">model</span><span class="p">,</span><span class="n">valid</span><span class="p">))</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Took </span><span class="si">%.1f</span><span class="s1"> seconds&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span><span class="o">-</span><span class="n">start</span><span class="p">))</span>

    <span class="k">del</span> <span class="n">model</span><span class="p">,</span> <span class="n">dtrain</span>

<span class="n">time_train</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span><span class="o">-</span><span class="n">time_train_start</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
#########################
### reply
#########################
Creating DMatrix...
Took 0.8 seconds
Training...
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
/opt/conda/envs/rapids/lib/python3.7/site-packages/distributed/client.py:3518: RuntimeWarning: coroutine &#39;Client._update_scheduler_info&#39; was never awaited
  self.sync(self._update_scheduler_info)
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Took 13.6 seconds
Predicting...
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
/opt/conda/envs/rapids/lib/python3.7/site-packages/distributed/worker.py:3385: UserWarning: Large object of size 4.13 MB detected in task graph:
  [&lt;function _predict_async.&lt;locals&gt;.mapped_predict  ... titions&gt;, True]
Consider scattering large objects ahead of time
with client.scatter to reduce scheduler burden and
keep data on workers

    future = client.submit(func, big_data)    # bad

    big_future = client.scatter(big_data)     # good
    future = client.submit(func, big_future)  # good
  % (format_bytes(len(b)), s)
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Took 0.4 seconds
#########################
### retweet
#########################
Creating DMatrix...
Took 0.1 seconds
Training...
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
/opt/conda/envs/rapids/lib/python3.7/site-packages/distributed/client.py:3518: RuntimeWarning: coroutine &#39;Client._update_scheduler_info&#39; was never awaited
  self.sync(self._update_scheduler_info)
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Took 13.6 seconds
Predicting...
Took 0.4 seconds
#########################
### retweet_comment
#########################
Creating DMatrix...
Took 0.1 seconds
Training...
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
/opt/conda/envs/rapids/lib/python3.7/site-packages/distributed/client.py:3518: RuntimeWarning: coroutine &#39;Client._update_scheduler_info&#39; was never awaited
  self.sync(self._update_scheduler_info)
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Took 12.5 seconds
Predicting...
Took 0.3 seconds
#########################
### like
#########################
Creating DMatrix...
Took 0.1 seconds
Training...
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
/opt/conda/envs/rapids/lib/python3.7/site-packages/distributed/client.py:3518: RuntimeWarning: coroutine &#39;Client._update_scheduler_info&#39; was never awaited
  self.sync(self._update_scheduler_info)
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Took 13.7 seconds
Predicting...
Took 0.5 seconds
CPU times: user 3.89 s, sys: 40.2 ms, total: 3.93 s
Wall time: 56.3 s
</pre></div></div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[43]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">yvalid</span> <span class="o">=</span> <span class="n">Y_valid</span><span class="p">[</span><span class="n">label_names</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">compute</span><span class="p">()</span>
<span class="n">oof</span> <span class="o">=</span> <span class="n">cp</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">i</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">compute</span><span class="p">()</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">preds</span><span class="p">])</span><span class="o">.</span><span class="n">T</span>
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[44]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">yvalid</span><span class="o">.</span><span class="n">shape</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[44]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
(10320615, 4)
</pre></div></div>
</div>
<p>The hosts of the RecSys2020 competition provide code for calculating the performance metric <code class="docutils literal notranslate"><span class="pre">PRAUC</span></code> and <code class="docutils literal notranslate"><span class="pre">RCE</span></code>. We optimized the code to speed up the calculation, as well. Using cuDF / cupy, we calculate the performance metric on the GPU.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[45]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">sklearn.metrics</span> <span class="kn">import</span> <span class="n">auc</span>

<span class="k">def</span> <span class="nf">precision_recall_curve</span><span class="p">(</span><span class="n">y_true</span><span class="p">,</span><span class="n">y_pred</span><span class="p">):</span>
    <span class="n">y_true</span> <span class="o">=</span> <span class="n">y_true</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;float32&#39;</span><span class="p">)</span>
    <span class="n">ids</span> <span class="o">=</span> <span class="n">cp</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="o">-</span><span class="n">y_pred</span><span class="p">)</span>
    <span class="n">y_true</span> <span class="o">=</span> <span class="n">y_true</span><span class="p">[</span><span class="n">ids</span><span class="p">]</span>
    <span class="n">y_pred</span> <span class="o">=</span> <span class="n">y_pred</span><span class="p">[</span><span class="n">ids</span><span class="p">]</span>
    <span class="n">y_pred</span> <span class="o">=</span> <span class="n">cp</span><span class="o">.</span><span class="n">flip</span><span class="p">(</span><span class="n">y_pred</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

    <span class="n">acc_one</span> <span class="o">=</span> <span class="n">cp</span><span class="o">.</span><span class="n">cumsum</span><span class="p">(</span><span class="n">y_true</span><span class="p">)</span>
    <span class="n">sum_one</span> <span class="o">=</span> <span class="n">cp</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">y_true</span><span class="p">)</span>

    <span class="n">precision</span> <span class="o">=</span> <span class="n">cp</span><span class="o">.</span><span class="n">flip</span><span class="p">(</span><span class="n">acc_one</span><span class="o">/</span><span class="n">cp</span><span class="o">.</span><span class="n">cumsum</span><span class="p">(</span><span class="n">cp</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">y_true</span><span class="p">))),</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">precision</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">precision</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
    <span class="n">precision</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.</span>

    <span class="n">recall</span> <span class="o">=</span> <span class="n">cp</span><span class="o">.</span><span class="n">flip</span><span class="p">(</span><span class="n">acc_one</span><span class="o">/</span><span class="n">sum_one</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">recall</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">recall</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
    <span class="n">recall</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">n</span> <span class="o">=</span> <span class="p">(</span><span class="n">recall</span><span class="o">==</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>

    <span class="k">return</span> <span class="n">precision</span><span class="p">[</span><span class="n">n</span><span class="o">-</span><span class="mi">1</span><span class="p">:],</span><span class="n">recall</span><span class="p">[</span><span class="n">n</span><span class="o">-</span><span class="mi">1</span><span class="p">:],</span><span class="n">y_pred</span><span class="p">[</span><span class="n">n</span><span class="p">:]</span>

<span class="k">def</span> <span class="nf">compute_prauc</span><span class="p">(</span><span class="n">pred</span><span class="p">,</span> <span class="n">gt</span><span class="p">):</span>
    <span class="n">prec</span><span class="p">,</span> <span class="n">recall</span><span class="p">,</span> <span class="n">thresh</span> <span class="o">=</span> <span class="n">precision_recall_curve</span><span class="p">(</span><span class="n">gt</span><span class="p">,</span> <span class="n">pred</span><span class="p">)</span>
    <span class="n">recall</span><span class="p">,</span> <span class="n">prec</span> <span class="o">=</span> <span class="n">cp</span><span class="o">.</span><span class="n">asnumpy</span><span class="p">(</span><span class="n">recall</span><span class="p">),</span> <span class="n">cp</span><span class="o">.</span><span class="n">asnumpy</span><span class="p">(</span><span class="n">prec</span><span class="p">)</span>

    <span class="n">prauc</span> <span class="o">=</span> <span class="n">auc</span><span class="p">(</span><span class="n">recall</span><span class="p">,</span> <span class="n">prec</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">prauc</span>

<span class="k">def</span> <span class="nf">log_loss</span><span class="p">(</span><span class="n">y_true</span><span class="p">,</span><span class="n">y_pred</span><span class="p">,</span><span class="n">eps</span><span class="o">=</span><span class="mf">1e-7</span><span class="p">,</span> <span class="n">normalize</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">sample_weight</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="n">y_true</span> <span class="o">=</span> <span class="n">y_true</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;int32&#39;</span><span class="p">)</span>
    <span class="n">y_pred</span> <span class="o">=</span> <span class="n">cp</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="n">y_pred</span><span class="p">,</span> <span class="n">eps</span><span class="p">,</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">eps</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">y_pred</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">y_pred</span> <span class="o">=</span> <span class="n">cp</span><span class="o">.</span><span class="n">expand_dims</span><span class="p">(</span><span class="n">y_pred</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">y_pred</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">y_pred</span> <span class="o">=</span> <span class="n">cp</span><span class="o">.</span><span class="n">hstack</span><span class="p">([</span><span class="mi">1</span> <span class="o">-</span> <span class="n">y_pred</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">])</span>

    <span class="n">y_pred</span> <span class="o">/=</span> <span class="n">cp</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">y_pred</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">keepdims</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">loss</span> <span class="o">=</span> <span class="o">-</span><span class="n">cp</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">y_pred</span><span class="p">)[</span><span class="n">cp</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">y_pred</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="n">y_true</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">_weighted_sum</span><span class="p">(</span><span class="n">loss</span><span class="p">,</span> <span class="n">sample_weight</span><span class="p">,</span> <span class="n">normalize</span><span class="p">)</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>

<span class="k">def</span> <span class="nf">_weighted_sum</span><span class="p">(</span><span class="n">sample_score</span><span class="p">,</span> <span class="n">sample_weight</span><span class="p">,</span> <span class="n">normalize</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">normalize</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">cp</span><span class="o">.</span><span class="n">average</span><span class="p">(</span><span class="n">sample_score</span><span class="p">,</span> <span class="n">weights</span><span class="o">=</span><span class="n">sample_weight</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">sample_weight</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">cp</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">sample_score</span><span class="p">,</span> <span class="n">sample_weight</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">sample_score</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>

<span class="k">def</span> <span class="nf">compute_rce_fast</span><span class="p">(</span><span class="n">pred</span><span class="p">,</span> <span class="n">gt</span><span class="p">):</span>
    <span class="n">cross_entropy</span> <span class="o">=</span> <span class="n">log_loss</span><span class="p">(</span><span class="n">gt</span><span class="p">,</span> <span class="n">pred</span><span class="p">)</span>
    <span class="n">yt</span> <span class="o">=</span> <span class="n">cp</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">gt</span><span class="p">)</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>
    <span class="c1"># cross_entropy and yt are single numbers (no arrays) and using CPU is fast</span>
    <span class="n">strawman_cross_entropy</span> <span class="o">=</span> <span class="o">-</span><span class="p">(</span><span class="n">yt</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">yt</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">yt</span><span class="p">)</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">yt</span><span class="p">))</span>
    <span class="k">return</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">-</span> <span class="n">cross_entropy</span><span class="o">/</span><span class="n">strawman_cross_entropy</span><span class="p">)</span><span class="o">*</span><span class="mf">100.0</span>
</pre></div>
</div>
</div>
<p>Finally, we calculate the performance metric PRAUC and RCE for each target.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[46]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">txt</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">4</span><span class="p">):</span>
    <span class="n">prauc</span> <span class="o">=</span> <span class="n">compute_prauc</span><span class="p">(</span><span class="n">oof</span><span class="p">[:,</span><span class="n">i</span><span class="p">],</span> <span class="n">yvalid</span><span class="p">[:,</span> <span class="n">i</span><span class="p">])</span>
    <span class="n">rce</span>   <span class="o">=</span> <span class="n">compute_rce_fast</span><span class="p">(</span><span class="n">oof</span><span class="p">[:,</span><span class="n">i</span><span class="p">],</span> <span class="n">yvalid</span><span class="p">[:,</span> <span class="n">i</span><span class="p">])</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>
    <span class="n">txt_</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">label_names</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="si">:</span><span class="s2">20</span><span class="si">}</span><span class="s2"> PRAUC:</span><span class="si">{</span><span class="n">prauc</span><span class="si">:</span><span class="s2">.5f</span><span class="si">}</span><span class="s2"> RCE:</span><span class="si">{</span><span class="n">rce</span><span class="si">:</span><span class="s2">.5f</span><span class="si">}</span><span class="s2">&quot;</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">txt_</span><span class="p">)</span>
    <span class="n">txt</span> <span class="o">+=</span> <span class="n">txt_</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
reply                PRAUC:0.13551 RCE:16.77993
retweet              PRAUC:0.51663 RCE:27.94596
retweet_comment      PRAUC:0.05005 RCE:10.55952
like                 PRAUC:0.76354 RCE:22.98230
</pre></div></div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[47]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">time_total</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span><span class="o">-</span><span class="n">time_total_start</span>
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[48]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Total time: </span><span class="si">{:.2f}</span><span class="s1">s&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">time_total</span><span class="p">))</span>
<span class="nb">print</span><span class="p">()</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;1. Preprocessing:       </span><span class="si">{:.2f}</span><span class="s1">s&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">time_preproc</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;2. Splitting:           </span><span class="si">{:.2f}</span><span class="s1">s&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">time_split</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;3. Feature engineering: </span><span class="si">{:.2f}</span><span class="s1">s&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">time_fe</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;4. Training:            </span><span class="si">{:.2f}</span><span class="s1">s&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">time_train</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Total time: 780.36s

1. Preprocessing:       337.52s
2. Splitting:           122.69s
3. Feature engineering: 234.35s
4. Training:            56.31s
</pre></div></div>
</div>
</div>
</div>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="outbrain.html" class="btn btn-neutral float-left" title="NVTabular demo on Outbrain Data" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="../api/index.html" class="btn btn-neutral float-right" title="API Documentation" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2021, NVIDIA.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  
<div class="rst-versions" data-toggle="rst-versions" role="note" aria-label="versions">
  <span class="rst-current-version" data-toggle="rst-current-version">
    <span class="fa fa-book"> Other Versions</span>
    v: v0.3.0
    <span class="fa fa-caret-down"></span>
  </span>
  <div class="rst-other-versions">
    <dl>
      <dt>Tags</dt>
      <dd><a href="../../v0.1.0/index.html">v0.1.0</a></dd>
      <dd><a href="../../v0.1.1/index.html">v0.1.1</a></dd>
      <dd><a href="../../v0.10.0/index.html">v0.10.0</a></dd>
      <dd><a href="../../v0.11.0/index.html">v0.11.0</a></dd>
      <dd><a href="../../v0.2.0/index.html">v0.2.0</a></dd>
      <dd><a href="recsys2020.html">v0.3.0</a></dd>
      <dd><a href="../../v0.4.0/index.html">v0.4.0</a></dd>
      <dd><a href="../../v0.5.0/index.html">v0.5.0</a></dd>
      <dd><a href="../../v0.5.1/index.html">v0.5.1</a></dd>
      <dd><a href="../../v0.5.2/index.html">v0.5.2</a></dd>
      <dd><a href="../../v0.5.3/index.html">v0.5.3</a></dd>
      <dd><a href="../../v0.6.0/index.html">v0.6.0</a></dd>
      <dd><a href="../../v0.6.1/index.html">v0.6.1</a></dd>
      <dd><a href="../../v0.7.0/index.html">v0.7.0</a></dd>
      <dd><a href="../../v0.7.1/index.html">v0.7.1</a></dd>
      <dd><a href="../../v0.8.0/index.html">v0.8.0</a></dd>
      <dd><a href="../../v0.9.0/index.html">v0.9.0</a></dd>
    </dl>
    <dl>
      <dt>Branches</dt>
      <dd><a href="../../main/index.html">main</a></dd>
    </dl>
  </div>
</div><script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>