<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>NVTabular / HugeCTR Criteo Example &mdash; NVTabular 2020 documentation</title><link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  <script id="documentation_options" data-url_root="../" src="../_static/documentation_options.js"></script>
        <script src="../_static/jquery.js"></script>
        <script src="../_static/underscore.js"></script>
        <script src="../_static/doctools.js"></script>
        <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
        <script async="async" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.7/latest.js?config=TeX-AMS-MML_HTMLorMML"></script>
        <script type="text/x-mathjax-config">MathJax.Hub.Config({"tex2jax": {"inlineMath": [["$", "$"], ["\\(", "\\)"]], "processEscapes": true, "ignoreClass": "tex2jax_ignore|mathjax_ignore|document", "processClass": "tex2jax_process|mathjax_process|math|output_area"}})</script>
    <script src="../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="NVTabular demo on Outbrain Data" href="outbrain.html" />
    <link rel="prev" title="Multi-GPU Scaling in NVTabular with Dask" href="multigpu.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
            <a href="../index.html" class="icon icon-home"> NVTabular
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../Introduction.html">Introduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="../HowItWorks.html">How it Works</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="index.html">Examples</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="criteo.html">Criteo Example</a></li>
<li class="toctree-l2"><a class="reference internal" href="rossmann.html">Rossmann Example</a></li>
<li class="toctree-l2"><a class="reference internal" href="multigpu.html">Multi-GPU Example</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">HugeCTR Example</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#Data-Prep">Data Prep</a></li>
<li class="toctree-l3"><a class="reference internal" href="#Dataset-and-Dataset-Schema">Dataset and Dataset Schema</a></li>
<li class="toctree-l3"><a class="reference internal" href="#Deploy-a-Distributed-Dask-Cluster">Deploy a Distributed-Dask Cluster</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#Initilize-Memory-Pools">Initilize Memory Pools</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#Preprocessing">Preprocessing</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#Frequency-Thresholding">Frequency Thresholding</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#Training">Training</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="outbrain.html">Outbrain Example</a></li>
<li class="toctree-l2"><a class="reference internal" href="recsys2020.html">RecSys2020 Example</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../api/index.html">API Documentation</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">NVTabular</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../index.html" class="icon icon-home"></a> &raquo;</li>
          <li><a href="index.html">Examples</a> &raquo;</li>
      <li>NVTabular / HugeCTR Criteo Example</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  
<style>
/* CSS for nbsphinx extension */

/* remove conflicting styling from Sphinx themes */
div.nbinput.container div.prompt *,
div.nboutput.container div.prompt *,
div.nbinput.container div.input_area pre,
div.nboutput.container div.output_area pre,
div.nbinput.container div.input_area .highlight,
div.nboutput.container div.output_area .highlight {
    border: none;
    padding: 0;
    margin: 0;
    box-shadow: none;
}

div.nbinput.container > div[class*=highlight],
div.nboutput.container > div[class*=highlight] {
    margin: 0;
}

div.nbinput.container div.prompt *,
div.nboutput.container div.prompt * {
    background: none;
}

div.nboutput.container div.output_area .highlight,
div.nboutput.container div.output_area pre {
    background: unset;
}

div.nboutput.container div.output_area div.highlight {
    color: unset;  /* override Pygments text color */
}

/* avoid gaps between output lines */
div.nboutput.container div[class*=highlight] pre {
    line-height: normal;
}

/* input/output containers */
div.nbinput.container,
div.nboutput.container {
    display: -webkit-flex;
    display: flex;
    align-items: flex-start;
    margin: 0;
    width: 100%;
}
@media (max-width: 540px) {
    div.nbinput.container,
    div.nboutput.container {
        flex-direction: column;
    }
}

/* input container */
div.nbinput.container {
    padding-top: 5px;
}

/* last container */
div.nblast.container {
    padding-bottom: 5px;
}

/* input prompt */
div.nbinput.container div.prompt pre {
    color: #307FC1;
}

/* output prompt */
div.nboutput.container div.prompt pre {
    color: #BF5B3D;
}

/* all prompts */
div.nbinput.container div.prompt,
div.nboutput.container div.prompt {
    width: 4.5ex;
    padding-top: 5px;
    position: relative;
    user-select: none;
}

div.nbinput.container div.prompt > div,
div.nboutput.container div.prompt > div {
    position: absolute;
    right: 0;
    margin-right: 0.3ex;
}

@media (max-width: 540px) {
    div.nbinput.container div.prompt,
    div.nboutput.container div.prompt {
        width: unset;
        text-align: left;
        padding: 0.4em;
    }
    div.nboutput.container div.prompt.empty {
        padding: 0;
    }

    div.nbinput.container div.prompt > div,
    div.nboutput.container div.prompt > div {
        position: unset;
    }
}

/* disable scrollbars on prompts */
div.nbinput.container div.prompt pre,
div.nboutput.container div.prompt pre {
    overflow: hidden;
}

/* input/output area */
div.nbinput.container div.input_area,
div.nboutput.container div.output_area {
    -webkit-flex: 1;
    flex: 1;
    overflow: auto;
}
@media (max-width: 540px) {
    div.nbinput.container div.input_area,
    div.nboutput.container div.output_area {
        width: 100%;
    }
}

/* input area */
div.nbinput.container div.input_area {
    border: 1px solid #e0e0e0;
    border-radius: 2px;
    /*background: #f5f5f5;*/
}

/* override MathJax center alignment in output cells */
div.nboutput.container div[class*=MathJax] {
    text-align: left !important;
}

/* override sphinx.ext.imgmath center alignment in output cells */
div.nboutput.container div.math p {
    text-align: left;
}

/* standard error */
div.nboutput.container div.output_area.stderr {
    background: #fdd;
}

/* ANSI colors */
.ansi-black-fg { color: #3E424D; }
.ansi-black-bg { background-color: #3E424D; }
.ansi-black-intense-fg { color: #282C36; }
.ansi-black-intense-bg { background-color: #282C36; }
.ansi-red-fg { color: #E75C58; }
.ansi-red-bg { background-color: #E75C58; }
.ansi-red-intense-fg { color: #B22B31; }
.ansi-red-intense-bg { background-color: #B22B31; }
.ansi-green-fg { color: #00A250; }
.ansi-green-bg { background-color: #00A250; }
.ansi-green-intense-fg { color: #007427; }
.ansi-green-intense-bg { background-color: #007427; }
.ansi-yellow-fg { color: #DDB62B; }
.ansi-yellow-bg { background-color: #DDB62B; }
.ansi-yellow-intense-fg { color: #B27D12; }
.ansi-yellow-intense-bg { background-color: #B27D12; }
.ansi-blue-fg { color: #208FFB; }
.ansi-blue-bg { background-color: #208FFB; }
.ansi-blue-intense-fg { color: #0065CA; }
.ansi-blue-intense-bg { background-color: #0065CA; }
.ansi-magenta-fg { color: #D160C4; }
.ansi-magenta-bg { background-color: #D160C4; }
.ansi-magenta-intense-fg { color: #A03196; }
.ansi-magenta-intense-bg { background-color: #A03196; }
.ansi-cyan-fg { color: #60C6C8; }
.ansi-cyan-bg { background-color: #60C6C8; }
.ansi-cyan-intense-fg { color: #258F8F; }
.ansi-cyan-intense-bg { background-color: #258F8F; }
.ansi-white-fg { color: #C5C1B4; }
.ansi-white-bg { background-color: #C5C1B4; }
.ansi-white-intense-fg { color: #A1A6B2; }
.ansi-white-intense-bg { background-color: #A1A6B2; }

.ansi-default-inverse-fg { color: #FFFFFF; }
.ansi-default-inverse-bg { background-color: #000000; }

.ansi-bold { font-weight: bold; }
.ansi-underline { text-decoration: underline; }


div.nbinput.container div.input_area div[class*=highlight] > pre,
div.nboutput.container div.output_area div[class*=highlight] > pre,
div.nboutput.container div.output_area div[class*=highlight].math,
div.nboutput.container div.output_area.rendered_html,
div.nboutput.container div.output_area > div.output_javascript,
div.nboutput.container div.output_area:not(.rendered_html) > img{
    padding: 5px;
    margin: 0;
}

/* fix copybtn overflow problem in chromium (needed for 'sphinx_copybutton') */
div.nbinput.container div.input_area > div[class^='highlight'],
div.nboutput.container div.output_area > div[class^='highlight']{
    overflow-y: hidden;
}

/* hide copybtn icon on prompts (needed for 'sphinx_copybutton') */
.prompt .copybtn {
    display: none;
}

/* Some additional styling taken form the Jupyter notebook CSS */
div.rendered_html table {
  border: none;
  border-collapse: collapse;
  border-spacing: 0;
  color: black;
  font-size: 12px;
  table-layout: fixed;
}
div.rendered_html thead {
  border-bottom: 1px solid black;
  vertical-align: bottom;
}
div.rendered_html tr,
div.rendered_html th,
div.rendered_html td {
  text-align: right;
  vertical-align: middle;
  padding: 0.5em 0.5em;
  line-height: normal;
  white-space: normal;
  max-width: none;
  border: none;
}
div.rendered_html th {
  font-weight: bold;
}
div.rendered_html tbody tr:nth-child(odd) {
  background: #f5f5f5;
}
div.rendered_html tbody tr:hover {
  background: rgba(66, 165, 245, 0.2);
}

/* CSS overrides for sphinx_rtd_theme */

/* 24px margin */
.nbinput.nblast.container,
.nboutput.nblast.container {
    margin-bottom: 19px;  /* padding has already 5px */
}

/* ... except between code cells! */
.nblast.container + .nbinput.container {
    margin-top: -19px;
}

.admonition > p:before {
    margin-right: 4px;  /* make room for the exclamation icon */
}

/* Fix math alignment, see https://github.com/rtfd/sphinx_rtd_theme/pull/686 */
.math {
    text-align: unset;
}
</style>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[1]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Copyright 2020 NVIDIA Corporation. All Rights Reserved.</span>
<span class="c1">#</span>
<span class="c1"># Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);</span>
<span class="c1"># you may not use this file except in compliance with the License.</span>
<span class="c1"># You may obtain a copy of the License at</span>
<span class="c1">#</span>
<span class="c1">#     http://www.apache.org/licenses/LICENSE-2.0</span>
<span class="c1">#</span>
<span class="c1"># Unless required by applicable law or agreed to in writing, software</span>
<span class="c1"># distributed under the License is distributed on an &quot;AS IS&quot; BASIS,</span>
<span class="c1"># WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.</span>
<span class="c1"># See the License for the specific language governing permissions and</span>
<span class="c1"># limitations under the License.</span>
<span class="c1"># ==============================================================================</span>
</pre></div>
</div>
</div>
<div class="section" id="NVTabular-/-HugeCTR-Criteo-Example">
<h1>NVTabular / HugeCTR Criteo Example<a class="headerlink" href="#NVTabular-/-HugeCTR-Criteo-Example" title="Permalink to this headline"></a></h1>
<p>Here we’ll show how to use NVTabular first as a preprocessing library to prepare the <a class="reference external" href="https://www.kaggle.com/c/criteo-display-ad-challenge">Criteo Display Advertising Challenge</a> dataset, and then train a model using HugeCTR.</p>
<div class="section" id="Data-Prep">
<h2>Data Prep<a class="headerlink" href="#Data-Prep" title="Permalink to this headline"></a></h2>
<p>Before we get started, make sure you’ve run the <a class="reference external" href="../optimize_criteo.ipynb">optimize_criteo notebook</a>, which will convert the tsv data published by Criteo into the parquet format that our accelerated readers prefer. It’s fair to mention at this point that that notebook will take ~30 minutes to run. While we’re hoping to release accelerated csv readers in the near future, we also believe that inefficiencies in existing data representations like csv are in no small part a consequence of
inefficiencies in the existing hardware/software stack. Accelerating these pipelines on new hardware like GPUs may require us to make new choices about the representations we use to store that data, and parquet represents a strong alternative.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[2]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Standard Libraries</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">from</span> <span class="nn">time</span> <span class="kn">import</span> <span class="n">time</span>
<span class="kn">import</span> <span class="nn">re</span>
<span class="kn">import</span> <span class="nn">shutil</span>
<span class="kn">import</span> <span class="nn">glob</span>
<span class="kn">import</span> <span class="nn">warnings</span>

<span class="c1"># External Dependencies</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">cupy</span> <span class="k">as</span> <span class="nn">cp</span>
<span class="kn">import</span> <span class="nn">cudf</span>
<span class="kn">import</span> <span class="nn">dask_cudf</span>
<span class="kn">from</span> <span class="nn">dask_cuda</span> <span class="kn">import</span> <span class="n">LocalCUDACluster</span>
<span class="kn">from</span> <span class="nn">dask.distributed</span> <span class="kn">import</span> <span class="n">Client</span>
<span class="kn">from</span> <span class="nn">dask.utils</span> <span class="kn">import</span> <span class="n">parse_bytes</span>
<span class="kn">from</span> <span class="nn">dask.delayed</span> <span class="kn">import</span> <span class="n">delayed</span>
<span class="kn">import</span> <span class="nn">rmm</span>

<span class="c1"># NVTabular</span>
<span class="kn">import</span> <span class="nn">nvtabular</span> <span class="k">as</span> <span class="nn">nvt</span>
<span class="kn">import</span> <span class="nn">nvtabular.ops</span> <span class="k">as</span> <span class="nn">ops</span>
<span class="kn">from</span> <span class="nn">nvtabular.io</span> <span class="kn">import</span> <span class="n">Shuffle</span>
<span class="kn">from</span> <span class="nn">nvtabular.utils</span> <span class="kn">import</span> <span class="n">_pynvml_mem_size</span><span class="p">,</span> <span class="n">device_mem_size</span>

<span class="c1"># HugeCTR</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="n">sys</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;/usr/local/hugectr/lib&quot;</span><span class="p">)</span>
<span class="kn">from</span> <span class="nn">hugectr</span> <span class="kn">import</span> <span class="n">Session</span><span class="p">,</span> <span class="n">solver_parser_helper</span><span class="p">,</span> <span class="n">get_learning_rate_scheduler</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="Dataset-and-Dataset-Schema">
<h2>Dataset and Dataset Schema<a class="headerlink" href="#Dataset-and-Dataset-Schema" title="Permalink to this headline"></a></h2>
<p>Once our data is ready, we’ll define some high level parameters to describe where our data is and what it “looks like” at a high level.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[3]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># define some information about where to get our data</span>
<span class="n">BASE_DIR</span> <span class="o">=</span> <span class="s2">&quot;/raid/criteo/tests/&quot;</span>
<span class="n">input_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">BASE_DIR</span><span class="p">,</span> <span class="s2">&quot;crit_int_pq&quot;</span><span class="p">)</span>
<span class="n">dask_workdir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">BASE_DIR</span><span class="p">,</span> <span class="s2">&quot;test_dask/workdir&quot;</span><span class="p">)</span>
<span class="n">output_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">BASE_DIR</span><span class="p">,</span> <span class="s2">&quot;test_dask/output&quot;</span><span class="p">)</span>
<span class="n">stats_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">BASE_DIR</span><span class="p">,</span> <span class="s2">&quot;test_dask/stats&quot;</span><span class="p">)</span>


<span class="c1">#BATCH_SIZE = int(os.environ.get(&#39;BATCH_SIZE&#39;, 800000))</span>
<span class="c1">#NUM_PARTS = int(os.environ.get(&#39;NUM_PARTS&#39;, 2))</span>
<span class="n">NUM_TRAIN_DAYS</span> <span class="o">=</span> <span class="mi">23</span> <span class="c1"># number of days worth of data to use for training, the rest will be used for validation</span>
<span class="n">NUM_GPUS</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">5</span><span class="p">,</span><span class="mi">6</span><span class="p">,</span><span class="mi">7</span><span class="p">]</span>

<span class="c1"># define our dataset schema</span>
<span class="n">CONTINUOUS_COLUMNS</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;I&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">14</span><span class="p">)]</span>
<span class="n">CATEGORICAL_COLUMNS</span> <span class="o">=</span>  <span class="p">[</span><span class="s1">&#39;C&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">27</span><span class="p">)]</span>
<span class="n">LABEL_COLUMNS</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;label&#39;</span><span class="p">]</span>
<span class="n">COLUMNS</span> <span class="o">=</span> <span class="n">CONTINUOUS_COLUMNS</span> <span class="o">+</span> <span class="n">CATEGORICAL_COLUMNS</span> <span class="o">+</span> <span class="n">LABEL_COLUMNS</span>

<span class="c1"># Make sure we have a clean worker space for Dask</span>
<span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">dask_workdir</span><span class="p">):</span>
    <span class="n">shutil</span><span class="o">.</span><span class="n">rmtree</span><span class="p">(</span><span class="n">dask_workdir</span><span class="p">)</span>
<span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">dask_workdir</span><span class="p">)</span>

<span class="c1"># Make sure we have a clean stats space for Dask</span>
<span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">stats_path</span><span class="p">):</span>
    <span class="n">shutil</span><span class="o">.</span><span class="n">rmtree</span><span class="p">(</span><span class="n">stats_path</span><span class="p">)</span>
<span class="n">os</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">stats_path</span><span class="p">)</span>

<span class="c1"># Make sure we have a clean output path</span>
<span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">output_path</span><span class="p">):</span>
    <span class="n">shutil</span><span class="o">.</span><span class="n">rmtree</span><span class="p">(</span><span class="n">output_path</span><span class="p">)</span>
<span class="n">os</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">output_path</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[4]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">!</span> ls <span class="nv">$BASE_DIR</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
crit_int_pq  NVTabular  test_dask
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[5]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">fname</span> <span class="o">=</span> <span class="s1">&#39;day_</span><span class="si">{}</span><span class="s1">.parquet&#39;</span>
<span class="n">num_days</span> <span class="o">=</span> <span class="nb">len</span><span class="p">([</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">input_path</span><span class="p">)</span> <span class="k">if</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">fname</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s1">&#39;[0-9]{1,2}&#39;</span><span class="p">),</span> <span class="n">i</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">])</span>
<span class="n">train_paths</span> <span class="o">=</span> <span class="p">[</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">input_path</span><span class="p">,</span> <span class="n">fname</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">day</span><span class="p">))</span> <span class="k">for</span> <span class="n">day</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">NUM_TRAIN_DAYS</span><span class="p">)]</span>
<span class="n">valid_paths</span> <span class="o">=</span> <span class="p">[</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">input_path</span><span class="p">,</span> <span class="n">fname</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">day</span><span class="p">))</span> <span class="k">for</span> <span class="n">day</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">NUM_TRAIN_DAYS</span><span class="p">,</span> <span class="n">num_days</span><span class="p">)]</span>
<span class="nb">print</span><span class="p">(</span><span class="n">train_paths</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">valid_paths</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
[&#39;/raid/criteo/tests/crit_int_pq/day_0.parquet&#39;, &#39;/raid/criteo/tests/crit_int_pq/day_1.parquet&#39;, &#39;/raid/criteo/tests/crit_int_pq/day_2.parquet&#39;, &#39;/raid/criteo/tests/crit_int_pq/day_3.parquet&#39;, &#39;/raid/criteo/tests/crit_int_pq/day_4.parquet&#39;, &#39;/raid/criteo/tests/crit_int_pq/day_5.parquet&#39;, &#39;/raid/criteo/tests/crit_int_pq/day_6.parquet&#39;, &#39;/raid/criteo/tests/crit_int_pq/day_7.parquet&#39;, &#39;/raid/criteo/tests/crit_int_pq/day_8.parquet&#39;, &#39;/raid/criteo/tests/crit_int_pq/day_9.parquet&#39;, &#39;/raid/criteo/tests/crit_int_pq/day_10.parquet&#39;, &#39;/raid/criteo/tests/crit_int_pq/day_11.parquet&#39;, &#39;/raid/criteo/tests/crit_int_pq/day_12.parquet&#39;, &#39;/raid/criteo/tests/crit_int_pq/day_13.parquet&#39;, &#39;/raid/criteo/tests/crit_int_pq/day_14.parquet&#39;, &#39;/raid/criteo/tests/crit_int_pq/day_15.parquet&#39;, &#39;/raid/criteo/tests/crit_int_pq/day_16.parquet&#39;, &#39;/raid/criteo/tests/crit_int_pq/day_17.parquet&#39;, &#39;/raid/criteo/tests/crit_int_pq/day_18.parquet&#39;, &#39;/raid/criteo/tests/crit_int_pq/day_19.parquet&#39;, &#39;/raid/criteo/tests/crit_int_pq/day_20.parquet&#39;, &#39;/raid/criteo/tests/crit_int_pq/day_21.parquet&#39;, &#39;/raid/criteo/tests/crit_int_pq/day_22.parquet&#39;]
[&#39;/raid/criteo/tests/crit_int_pq/day_23.parquet&#39;]
</pre></div></div>
</div>
</div>
<div class="section" id="Deploy-a-Distributed-Dask-Cluster">
<h2>Deploy a Distributed-Dask Cluster<a class="headerlink" href="#Deploy-a-Distributed-Dask-Cluster" title="Permalink to this headline"></a></h2>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[6]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Dask dashboard</span>
<span class="n">dashboard_port</span> <span class="o">=</span> <span class="s2">&quot;8787&quot;</span>

<span class="c1"># Deploy a Single-Machine Multi-GPU Cluster</span>
<span class="n">protocol</span> <span class="o">=</span> <span class="s2">&quot;tcp&quot;</span>             <span class="c1"># &quot;tcp&quot; or &quot;ucx&quot;</span>
<span class="n">visible_devices</span> <span class="o">=</span> <span class="s2">&quot;,&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="nb">str</span><span class="p">(</span><span class="n">n</span><span class="p">)</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">NUM_GPUS</span><span class="p">])</span>  <span class="c1"># Delect devices to place workers</span>
<span class="n">device_limit_frac</span> <span class="o">=</span> <span class="mf">0.7</span>      <span class="c1"># Spill GPU-Worker memory to host at this limit.</span>
<span class="n">device_pool_frac</span> <span class="o">=</span> <span class="mf">0.8</span>
<span class="n">part_mem_frac</span> <span class="o">=</span> <span class="mf">0.15</span>

<span class="c1"># Use total device size to calculate args.device_limit_frac</span>
<span class="n">device_size</span> <span class="o">=</span> <span class="n">device_mem_size</span><span class="p">(</span><span class="n">kind</span><span class="o">=</span><span class="s2">&quot;total&quot;</span><span class="p">)</span>
<span class="n">device_limit</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">device_limit_frac</span> <span class="o">*</span> <span class="n">device_size</span><span class="p">)</span>
<span class="n">device_pool_size</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">device_pool_frac</span> <span class="o">*</span> <span class="n">device_size</span><span class="p">)</span>
<span class="n">part_size</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">part_mem_frac</span> <span class="o">*</span> <span class="n">device_size</span><span class="p">)</span>

<span class="c1"># Check if any device memory is already occupied</span>
<span class="k">for</span> <span class="n">dev</span> <span class="ow">in</span> <span class="n">visible_devices</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;,&quot;</span><span class="p">):</span>
    <span class="n">fmem</span> <span class="o">=</span> <span class="n">_pynvml_mem_size</span><span class="p">(</span><span class="n">kind</span><span class="o">=</span><span class="s2">&quot;free&quot;</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span>
    <span class="n">used</span> <span class="o">=</span> <span class="p">(</span><span class="n">device_size</span> <span class="o">-</span> <span class="n">fmem</span><span class="p">)</span> <span class="o">/</span> <span class="mf">1e9</span>
    <span class="k">if</span> <span class="n">used</span> <span class="o">&gt;</span> <span class="mf">1.0</span><span class="p">:</span>
        <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;BEWARE - </span><span class="si">{</span><span class="n">used</span><span class="si">}</span><span class="s2"> GB is already occupied on device </span><span class="si">{</span><span class="nb">int</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span><span class="si">}</span><span class="s2">!&quot;</span><span class="p">)</span>

<span class="n">cluster</span> <span class="o">=</span> <span class="kc">None</span>               <span class="c1"># (Optional) Specify existing scheduler port</span>
<span class="k">if</span> <span class="n">cluster</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
    <span class="n">cluster</span> <span class="o">=</span> <span class="n">LocalCUDACluster</span><span class="p">(</span>
        <span class="n">protocol</span> <span class="o">=</span> <span class="n">protocol</span><span class="p">,</span>
        <span class="n">n_workers</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">visible_devices</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;,&quot;</span><span class="p">)),</span>
        <span class="n">CUDA_VISIBLE_DEVICES</span> <span class="o">=</span> <span class="n">visible_devices</span><span class="p">,</span>
        <span class="n">device_memory_limit</span> <span class="o">=</span> <span class="n">device_limit</span><span class="p">,</span>
        <span class="n">local_directory</span><span class="o">=</span><span class="n">dask_workdir</span><span class="p">,</span>
        <span class="n">dashboard_address</span><span class="o">=</span><span class="s2">&quot;:&quot;</span> <span class="o">+</span> <span class="n">dashboard_port</span><span class="p">,</span>
    <span class="p">)</span>

<span class="c1"># Create the distributed client</span>
<span class="n">client</span> <span class="o">=</span> <span class="n">Client</span><span class="p">(</span><span class="n">cluster</span><span class="p">)</span>
<span class="n">client</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[6]:
</pre></div>
</div>
<div class="output_area rendered_html docutils container">
<table style="border: 2px solid white;">
<tr>
<td style="vertical-align: top; border: 0px solid white">
<h3 style="text-align: left;">Client</h3>
<ul style="text-align: left; list-style: none; margin: 0; padding: 0;">
  <li><b>Scheduler: </b>tcp://127.0.0.1:43467</li>
  <li><b>Dashboard: </b><a href='http://127.0.0.1:8787/status' target='_blank'>http://127.0.0.1:8787/status</a></li>
</ul>
</td>
<td style="vertical-align: top; border: 0px solid white">
<h3 style="text-align: left;">Cluster</h3>
<ul style="text-align: left; list-style:none; margin: 0; padding: 0;">
  <li><b>Workers: </b>8</li>
  <li><b>Cores: </b>8</li>
  <li><b>Memory: </b>2.16 TB</li>
</ul>
</td>
</tr>
</table></div>
</div>
<div class="section" id="Initilize-Memory-Pools">
<h3>Initilize Memory Pools<a class="headerlink" href="#Initilize-Memory-Pools" title="Permalink to this headline"></a></h3>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[7]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Initialize RMM pool on ALL workers</span>
<span class="k">def</span> <span class="nf">_rmm_pool</span><span class="p">():</span>
    <span class="n">rmm</span><span class="o">.</span><span class="n">reinitialize</span><span class="p">(</span>
        <span class="c1"># RMM may require the pool size to be a multiple of 256.</span>
        <span class="n">pool_allocator</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">initial_pool_size</span><span class="o">=</span><span class="p">(</span><span class="n">device_pool_size</span> <span class="o">//</span> <span class="mi">256</span><span class="p">)</span> <span class="o">*</span> <span class="mi">256</span><span class="p">,</span> <span class="c1"># Use default size</span>
    <span class="p">)</span>

<span class="n">client</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">_rmm_pool</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[7]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
{&#39;tcp://127.0.0.1:34419&#39;: None,
 &#39;tcp://127.0.0.1:34529&#39;: None,
 &#39;tcp://127.0.0.1:34703&#39;: None,
 &#39;tcp://127.0.0.1:34721&#39;: None,
 &#39;tcp://127.0.0.1:37447&#39;: None,
 &#39;tcp://127.0.0.1:40953&#39;: None,
 &#39;tcp://127.0.0.1:42517&#39;: None,
 &#39;tcp://127.0.0.1:44611&#39;: None}
</pre></div></div>
</div>
</div>
</div>
<div class="section" id="Preprocessing">
<h2>Preprocessing<a class="headerlink" href="#Preprocessing" title="Permalink to this headline"></a></h2>
<p>At this point, our data still isn’t in a form that’s ideal for consumption by neural networks. The most pressing issues are missing values and the fact that our categorical variables are still represented by random, discrete identifiers, and need to be transformed into contiguous indices that can be leveraged by a learned embedding. Less pressing, but still important for learning dynamics, are the distributions of our continuous variables, which are distributed across multiple orders of
magnitude and are uncentered (i.e. E[x] != 0).</p>
<p>We can fix these issues in a conscise and GPU-accelerated manner with an NVTabular <code class="docutils literal notranslate"><span class="pre">Workflow</span></code>. We’ll instantiate one with our current dataset schema, then symbolically add operations <em>on</em> that schema. By setting all these <code class="docutils literal notranslate"><span class="pre">Ops</span></code> to use <code class="docutils literal notranslate"><span class="pre">replace=True</span></code>, the schema itself will remain unmodified, while the variables represented by each field in the schema will be transformed.</p>
<div class="section" id="Frequency-Thresholding">
<h3>Frequency Thresholding<a class="headerlink" href="#Frequency-Thresholding" title="Permalink to this headline"></a></h3>
<p>One interesting thing worth pointing out is that we’re using <em>frequency thresholding</em> in our <code class="docutils literal notranslate"><span class="pre">Categorify</span></code> op. This handy functionality will map all categories which occur in the dataset with some threshold level of infrequency (which we’ve set here to be 15 occurrences throughout the dataset) to the <em>same</em> index, keeping the model from overfitting to sparse signals.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[8]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">proc</span> <span class="o">=</span> <span class="n">nvt</span><span class="o">.</span><span class="n">Workflow</span><span class="p">(</span>
    <span class="n">cat_names</span><span class="o">=</span><span class="n">CATEGORICAL_COLUMNS</span><span class="p">,</span>
    <span class="n">cont_names</span><span class="o">=</span><span class="n">CONTINUOUS_COLUMNS</span><span class="p">,</span>
    <span class="n">label_name</span><span class="o">=</span><span class="n">LABEL_COLUMNS</span><span class="p">,</span>
    <span class="n">client</span> <span class="o">=</span> <span class="n">client</span><span class="p">)</span>

<span class="c1"># log -&gt; normalize continuous features. Note that doing this in the opposite</span>
<span class="c1"># order wouldn&#39;t make sense! Note also that we&#39;re zero filling continuous</span>
<span class="c1"># values before the log: this is a good time to remember that LogOp</span>
<span class="c1"># performs log(1+x), not log(x)</span>
<span class="n">proc</span><span class="o">.</span><span class="n">add_cont_feature</span><span class="p">([</span><span class="n">ops</span><span class="o">.</span><span class="n">FillMissing</span><span class="p">(),</span> <span class="n">ops</span><span class="o">.</span><span class="n">Clip</span><span class="p">(</span><span class="n">min_value</span><span class="o">=</span><span class="mi">0</span><span class="p">),</span> <span class="n">ops</span><span class="o">.</span><span class="n">LogOp</span><span class="p">()])</span>

<span class="c1"># categorification w/ MOD 10M</span>
<span class="n">num_buckets</span> <span class="o">=</span> <span class="mi">10000000</span>
<span class="n">proc</span><span class="o">.</span><span class="n">add_cat_preprocess</span><span class="p">([</span><span class="n">ops</span><span class="o">.</span><span class="n">Categorify</span><span class="p">(</span><span class="n">out_path</span><span class="o">=</span><span class="n">stats_path</span><span class="p">),</span> <span class="n">ops</span><span class="o">.</span><span class="n">LambdaOp</span><span class="p">(</span><span class="n">op_name</span><span class="o">=</span><span class="s2">&quot;MOD10M&quot;</span><span class="p">,</span> <span class="n">f</span><span class="o">=</span><span class="k">lambda</span> <span class="n">col</span><span class="p">,</span> <span class="n">gdf</span><span class="p">:</span> <span class="n">col</span> <span class="o">%</span> <span class="n">num_buckets</span><span class="p">)])</span>
</pre></div>
</div>
</div>
<p>Now instantiate dataset iterators to loop through our dataset (which we couldn’t fit into GPU memory). We need to enforce the required HugeCTR data types, so we set them in a dictionary and give as an argument when creating our dataset</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[9]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">dict_dtypes</span><span class="o">=</span><span class="p">{}</span>

<span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">CATEGORICAL_COLUMNS</span><span class="p">:</span>
    <span class="n">dict_dtypes</span><span class="p">[</span><span class="n">col</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">int64</span>

<span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">CONTINUOUS_COLUMNS</span><span class="p">:</span>
    <span class="n">dict_dtypes</span><span class="p">[</span><span class="n">col</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">float32</span>

<span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">LABEL_COLUMNS</span><span class="p">:</span>
    <span class="n">dict_dtypes</span><span class="p">[</span><span class="n">col</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">float32</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[10]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">train_dataset</span> <span class="o">=</span> <span class="n">nvt</span><span class="o">.</span><span class="n">Dataset</span><span class="p">(</span><span class="n">train_paths</span><span class="p">,</span> <span class="n">engine</span><span class="o">=</span><span class="s1">&#39;parquet&#39;</span><span class="p">,</span> <span class="n">part_size</span><span class="o">=</span><span class="n">part_size</span><span class="p">)</span>
<span class="n">valid_dataset</span> <span class="o">=</span> <span class="n">nvt</span><span class="o">.</span><span class="n">Dataset</span><span class="p">(</span><span class="n">valid_paths</span><span class="p">,</span> <span class="n">engine</span><span class="o">=</span><span class="s1">&#39;parquet&#39;</span><span class="p">,</span> <span class="n">part_size</span><span class="o">=</span><span class="n">part_size</span><span class="p">)</span>
</pre></div>
</div>
</div>
<p>Now run them through our workflows to collect statistics on the train set, then transform and save to parquet files.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[11]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">output_train_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">output_path</span><span class="p">,</span> <span class="s1">&#39;train/&#39;</span><span class="p">)</span>
<span class="n">output_valid_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">output_path</span><span class="p">,</span> <span class="s1">&#39;valid/&#39;</span><span class="p">)</span>
<span class="o">!</span> mkdir -p <span class="nv">$output_train_dir</span>
<span class="o">!</span> mkdir -p <span class="nv">$output_valid_dir</span>
</pre></div>
</div>
</div>
<p>For reference, let’s time it to see how long it takes…</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[12]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%%time</span>
<span class="n">proc</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">train_dataset</span><span class="p">,</span> <span class="n">shuffle</span><span class="o">=</span><span class="n">nvt</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">Shuffle</span><span class="o">.</span><span class="n">PER_PARTITION</span><span class="p">,</span> <span class="n">output_format</span><span class="o">=</span><span class="s2">&quot;parquet&quot;</span><span class="p">,</span> <span class="n">output_path</span><span class="o">=</span><span class="n">output_train_dir</span><span class="p">,</span> <span class="n">dtypes</span><span class="o">=</span><span class="n">dict_dtypes</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
CPU times: user 18.6 s, sys: 1.84 s, total: 20.5 s
Wall time: 2min 49s
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[13]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%%time</span>
<span class="n">proc</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">valid_dataset</span><span class="p">,</span> <span class="n">record_stats</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">shuffle</span><span class="o">=</span><span class="n">nvt</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">Shuffle</span><span class="o">.</span><span class="n">PER_PARTITION</span><span class="p">,</span> <span class="n">output_format</span><span class="o">=</span><span class="s2">&quot;parquet&quot;</span><span class="p">,</span> <span class="n">output_path</span><span class="o">=</span><span class="n">output_valid_dir</span><span class="p">,</span> <span class="n">dtypes</span><span class="o">=</span><span class="n">dict_dtypes</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
CPU times: user 853 ms, sys: 260 ms, total: 1.11 s
Wall time: 11.9 s
</pre></div></div>
</div>
<p>Get the embeddings table size, to configurate <code class="docutils literal notranslate"><span class="pre">slot_size_array</span></code> in <code class="docutils literal notranslate"><span class="pre">dlrm_fp32_64k.json</span></code></p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[14]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">embeddings</span> <span class="o">=</span> <span class="p">[</span><span class="n">c</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">ops</span><span class="o">.</span><span class="n">get_embedding_sizes</span><span class="p">(</span><span class="n">proc</span><span class="p">)</span><span class="o">.</span><span class="n">values</span><span class="p">()]</span>
<span class="n">embeddings</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="n">a</span><span class="o">=</span><span class="n">embeddings</span><span class="p">,</span> <span class="n">a_min</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">a_max</span><span class="o">=</span><span class="n">num_buckets</span><span class="p">)</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
<span class="nb">print</span><span class="p">(</span><span class="n">embeddings</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
[10000000, 10000000, 3014529, 400781, 11, 2209, 11869, 148, 4, 977, 15, 38713, 10000000, 10000000, 10000000, 584616, 12883, 109, 37, 17177, 7425, 20266, 4, 7085, 1535, 64]
</pre></div></div>
</div>
<p>And just like that, we have training and validation sets ready to feed to a model!</p>
<div class="section" id="HugeCTR">
<h4>HugeCTR<a class="headerlink" href="#HugeCTR" title="Permalink to this headline"></a></h4>
</div>
</div>
</div>
<div class="section" id="Training">
<h2>Training<a class="headerlink" href="#Training" title="Permalink to this headline"></a></h2>
<p>We’ll run huge_ctr using the DLRM configuration file.</p>
<p>First, we’ll shutdown our Dask client from earlier to free up some memory so that we can share it with HugeCTR.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[15]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">client</span><span class="o">.</span><span class="n">shutdown</span><span class="p">()</span>
</pre></div>
</div>
</div>
<p>Finally, we run HugeCTR. For reference, let’s time it to see how long it takes…</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[16]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%%time</span>
<span class="c1"># Set config file</span>
<span class="n">json_file</span> <span class="o">=</span> <span class="s2">&quot;dlrm_fp32_64k.json&quot;</span>
<span class="c1"># Set solver config</span>
<span class="n">solver_config</span> <span class="o">=</span> <span class="n">solver_parser_helper</span><span class="p">(</span><span class="n">seed</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
                                     <span class="n">batchsize</span> <span class="o">=</span> <span class="mi">16384</span><span class="p">,</span>
                                     <span class="n">batchsize_eval</span> <span class="o">=</span> <span class="mi">16384</span><span class="p">,</span>
                                     <span class="n">model_file</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
                                     <span class="n">embedding_files</span> <span class="o">=</span> <span class="p">[],</span>
                                     <span class="n">vvgpu</span> <span class="o">=</span> <span class="p">[</span><span class="n">NUM_GPUS</span><span class="p">],</span>
                                     <span class="n">use_mixed_precision</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
                                     <span class="n">scaler</span> <span class="o">=</span> <span class="mf">1.0</span><span class="p">,</span>
                                     <span class="n">i64_input_key</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
                                     <span class="n">use_algorithm_search</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
                                     <span class="n">use_cuda_graph</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
                                     <span class="n">repeat_dataset</span> <span class="o">=</span> <span class="kc">True</span>
                                    <span class="p">)</span>
<span class="c1"># Set learning rate</span>
<span class="n">lr_sch</span> <span class="o">=</span> <span class="n">get_learning_rate_scheduler</span><span class="p">(</span><span class="n">json_file</span><span class="p">)</span>
<span class="c1"># Train model</span>
<span class="n">sess</span> <span class="o">=</span> <span class="n">Session</span><span class="p">(</span><span class="n">solver_config</span><span class="p">,</span> <span class="n">json_file</span><span class="p">)</span>
<span class="n">sess</span><span class="o">.</span><span class="n">start_data_reading</span><span class="p">()</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">10000</span><span class="p">):</span>
    <span class="n">lr</span> <span class="o">=</span> <span class="n">lr_sch</span><span class="o">.</span><span class="n">get_next</span><span class="p">()</span>
    <span class="n">sess</span><span class="o">.</span><span class="n">set_learning_rate</span><span class="p">(</span><span class="n">lr</span><span class="p">)</span>
    <span class="n">sess</span><span class="o">.</span><span class="n">train</span><span class="p">()</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">i</span><span class="o">%</span><span class="mi">100</span> <span class="o">==</span> <span class="mi">0</span><span class="p">):</span>
        <span class="n">loss</span> <span class="o">=</span> <span class="n">sess</span><span class="o">.</span><span class="n">get_current_loss</span><span class="p">()</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;[HUGECTR][INFO] iter: </span><span class="si">{}</span><span class="s2">; loss: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">loss</span><span class="p">))</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">i</span><span class="o">%</span><span class="mi">3000</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">i</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">):</span>
        <span class="n">metrics</span> <span class="o">=</span> <span class="n">sess</span><span class="o">.</span><span class="n">evaluation</span><span class="p">()</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;[HUGECTR][INFO] iter: </span><span class="si">{}</span><span class="s2">, </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">metrics</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
[HUGECTR][INFO] iter: 0; loss: 0.8532629609107971
[HUGECTR][INFO] iter: 100; loss: 0.13733375072479248
[HUGECTR][INFO] iter: 200; loss: 0.12044114619493484
[HUGECTR][INFO] iter: 300; loss: 0.1432936042547226
[HUGECTR][INFO] iter: 400; loss: 0.13736993074417114
[HUGECTR][INFO] iter: 500; loss: 0.13921479880809784
[HUGECTR][INFO] iter: 600; loss: 0.12881088256835938
[HUGECTR][INFO] iter: 700; loss: 0.12584912776947021
[HUGECTR][INFO] iter: 800; loss: 0.1269063502550125
[HUGECTR][INFO] iter: 900; loss: 0.1276361644268036
[HUGECTR][INFO] iter: 1000; loss: 0.12601923942565918
[HUGECTR][INFO] iter: 1100; loss: 0.12928898632526398
[HUGECTR][INFO] iter: 1200; loss: 0.12370038777589798
[HUGECTR][INFO] iter: 1300; loss: 0.13637907803058624
[HUGECTR][INFO] iter: 1400; loss: 0.12262138724327087
[HUGECTR][INFO] iter: 1500; loss: 0.12716645002365112
[HUGECTR][INFO] iter: 1600; loss: 0.12878908216953278
[HUGECTR][INFO] iter: 1700; loss: 0.13806402683258057
[HUGECTR][INFO] iter: 1800; loss: 0.12637314200401306
[HUGECTR][INFO] iter: 1900; loss: 0.1234893649816513
[HUGECTR][INFO] iter: 2000; loss: 0.12500672042369843
[HUGECTR][INFO] iter: 2100; loss: 0.1271117925643921
[HUGECTR][INFO] iter: 2200; loss: 0.12065654993057251
[HUGECTR][INFO] iter: 2300; loss: 0.12455953657627106
[HUGECTR][INFO] iter: 2400; loss: 0.13445869088172913
[HUGECTR][INFO] iter: 2500; loss: 0.12091702222824097
[HUGECTR][INFO] iter: 2600; loss: 0.1275034099817276
[HUGECTR][INFO] iter: 2700; loss: 0.12200944125652313
[HUGECTR][INFO] iter: 2800; loss: 0.12480510026216507
[HUGECTR][INFO] iter: 2900; loss: 0.12914004921913147
[HUGECTR][INFO] iter: 3000; loss: 0.12693384289741516
[HUGECTR][INFO] iter: 3000, [(&#39;AUC&#39;, 0.7665499448776245)]
[HUGECTR][INFO] iter: 3100; loss: 0.12380503118038177
[HUGECTR][INFO] iter: 3200; loss: 0.12198879569768906
[HUGECTR][INFO] iter: 3300; loss: 0.11890366673469543
[HUGECTR][INFO] iter: 3400; loss: 0.11795458942651749
[HUGECTR][INFO] iter: 3500; loss: 0.1266060322523117
[HUGECTR][INFO] iter: 3600; loss: 0.1308339685201645
[HUGECTR][INFO] iter: 3700; loss: 0.11925296485424042
[HUGECTR][INFO] iter: 3800; loss: 0.12146525084972382
[HUGECTR][INFO] iter: 3900; loss: 0.1292012482881546
[HUGECTR][INFO] iter: 4000; loss: 0.12852615118026733
[HUGECTR][INFO] iter: 4100; loss: 0.128790944814682
[HUGECTR][INFO] iter: 4200; loss: 0.13038936257362366
[HUGECTR][INFO] iter: 4300; loss: 0.13004642724990845
[HUGECTR][INFO] iter: 4400; loss: 0.12568017840385437
[HUGECTR][INFO] iter: 4500; loss: 0.12528616189956665
[HUGECTR][INFO] iter: 4600; loss: 0.12257300317287445
[HUGECTR][INFO] iter: 4700; loss: 0.12529920041561127
[HUGECTR][INFO] iter: 4800; loss: 0.12477346509695053
[HUGECTR][INFO] iter: 4900; loss: 0.12581917643547058
[HUGECTR][INFO] iter: 5000; loss: 0.12937895953655243
[HUGECTR][INFO] iter: 5100; loss: 0.12715725600719452
[HUGECTR][INFO] iter: 5200; loss: 0.1305316984653473
[HUGECTR][INFO] iter: 5300; loss: 0.12407000362873077
[HUGECTR][INFO] iter: 5400; loss: 0.11724398285150528
[HUGECTR][INFO] iter: 5500; loss: 0.1297476887702942
[HUGECTR][INFO] iter: 5600; loss: 0.1252257376909256
[HUGECTR][INFO] iter: 5700; loss: 0.13481514155864716
[HUGECTR][INFO] iter: 5800; loss: 0.11881910264492035
[HUGECTR][INFO] iter: 5900; loss: 0.1231309324502945
[HUGECTR][INFO] iter: 6000; loss: 0.11981914937496185
[HUGECTR][INFO] iter: 6000, [(&#39;AUC&#39;, 0.7478535175323486)]
[HUGECTR][INFO] iter: 6100; loss: 0.12740889191627502
[HUGECTR][INFO] iter: 6200; loss: 0.1184406653046608
[HUGECTR][INFO] iter: 6300; loss: 0.1215326264500618
[HUGECTR][INFO] iter: 6400; loss: 0.12018976360559464
[HUGECTR][INFO] iter: 6500; loss: 0.12207344174385071
[HUGECTR][INFO] iter: 6600; loss: 0.11936748027801514
[HUGECTR][INFO] iter: 6700; loss: 0.1344636082649231
[HUGECTR][INFO] iter: 6800; loss: 0.1235312819480896
[HUGECTR][INFO] iter: 6900; loss: 0.11865617334842682
[HUGECTR][INFO] iter: 7000; loss: 0.12486278265714645
[HUGECTR][INFO] iter: 7100; loss: 0.13070285320281982
[HUGECTR][INFO] iter: 7200; loss: 0.12883560359477997
[HUGECTR][INFO] iter: 7300; loss: 0.12401801347732544
[HUGECTR][INFO] iter: 7400; loss: 0.12302699685096741
[HUGECTR][INFO] iter: 7500; loss: 0.13381913304328918
[HUGECTR][INFO] iter: 7600; loss: 0.12709784507751465
[HUGECTR][INFO] iter: 7700; loss: 0.12482510507106781
[HUGECTR][INFO] iter: 7800; loss: 0.12176606804132462
[HUGECTR][INFO] iter: 7900; loss: 0.12543131411075592
[HUGECTR][INFO] iter: 8000; loss: 0.11884783953428268
[HUGECTR][INFO] iter: 8100; loss: 0.1285083293914795
[HUGECTR][INFO] iter: 8200; loss: 0.12941600382328033
[HUGECTR][INFO] iter: 8300; loss: 0.1245264783501625
[HUGECTR][INFO] iter: 8400; loss: 0.1230475902557373
[HUGECTR][INFO] iter: 8500; loss: 0.1257411241531372
[HUGECTR][INFO] iter: 8600; loss: 0.12116973102092743
[HUGECTR][INFO] iter: 8700; loss: 0.12535282969474792
[HUGECTR][INFO] iter: 8800; loss: 0.12397449463605881
[HUGECTR][INFO] iter: 8900; loss: 0.12262888252735138
[HUGECTR][INFO] iter: 9000; loss: 0.11161893606185913
[HUGECTR][INFO] iter: 9000, [(&#39;AUC&#39;, 0.7808812856674194)]
[HUGECTR][INFO] iter: 9100; loss: 0.13083060085773468
[HUGECTR][INFO] iter: 9200; loss: 0.120280422270298
[HUGECTR][INFO] iter: 9300; loss: 0.12189973145723343
[HUGECTR][INFO] iter: 9400; loss: 0.11685363948345184
[HUGECTR][INFO] iter: 9500; loss: 0.12826286256313324
[HUGECTR][INFO] iter: 9600; loss: 0.11898329108953476
[HUGECTR][INFO] iter: 9700; loss: 0.12399856001138687
[HUGECTR][INFO] iter: 9800; loss: 0.11943891644477844
[HUGECTR][INFO] iter: 9900; loss: 0.12630650401115417
CPU times: user 8min 55s, sys: 45.3 s, total: 9min 40s
Wall time: 1min 39s
</pre></div></div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[17]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>
</pre></div>
</div>
</div>
</div>
</div>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="multigpu.html" class="btn btn-neutral float-left" title="Multi-GPU Scaling in NVTabular with Dask" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="outbrain.html" class="btn btn-neutral float-right" title="NVTabular demo on Outbrain Data" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2021, NVIDIA.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  
<div class="rst-versions" data-toggle="rst-versions" role="note" aria-label="versions">
  <span class="rst-current-version" data-toggle="rst-current-version">
    <span class="fa fa-book"> Other Versions</span>
    v: v0.3.0
    <span class="fa fa-caret-down"></span>
  </span>
  <div class="rst-other-versions">
    <dl>
      <dt>Tags</dt>
      <dd><a href="../../v0.1.0/index.html">v0.1.0</a></dd>
      <dd><a href="../../v0.1.1/index.html">v0.1.1</a></dd>
      <dd><a href="../../v0.10.0/index.html">v0.10.0</a></dd>
      <dd><a href="../../v0.11.0/index.html">v0.11.0</a></dd>
      <dd><a href="../../v0.2.0/index.html">v0.2.0</a></dd>
      <dd><a href="hugectr.html">v0.3.0</a></dd>
      <dd><a href="../../v0.4.0/index.html">v0.4.0</a></dd>
      <dd><a href="../../v0.5.0/index.html">v0.5.0</a></dd>
      <dd><a href="../../v0.5.1/index.html">v0.5.1</a></dd>
      <dd><a href="../../v0.5.2/index.html">v0.5.2</a></dd>
      <dd><a href="../../v0.5.3/index.html">v0.5.3</a></dd>
      <dd><a href="../../v0.6.0/index.html">v0.6.0</a></dd>
      <dd><a href="../../v0.6.1/index.html">v0.6.1</a></dd>
      <dd><a href="../../v0.7.0/index.html">v0.7.0</a></dd>
      <dd><a href="../../v0.7.1/index.html">v0.7.1</a></dd>
      <dd><a href="../../v0.8.0/index.html">v0.8.0</a></dd>
      <dd><a href="../../v0.9.0/index.html">v0.9.0</a></dd>
    </dl>
    <dl>
      <dt>Branches</dt>
      <dd><a href="../../main/index.html">main</a></dd>
    </dl>
  </div>
</div><script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>